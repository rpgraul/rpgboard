import{canvas}from"./canvas.js";let history=[],historyIndex=-1,isLocked=!1;export function initializeHistory(){saveState();["object:modified","object:added","object:removed","path:created","object:rotated","object:scaled"].forEach((evt=>{canvas.on(evt,(()=>{isLocked||saveState()}))}));const btnUndo=document.getElementById("btn-undo"),btnRedo=document.getElementById("btn-redo");btnUndo&&(btnUndo.onclick=e=>{e.preventDefault(),undo()}),btnRedo&&(btnRedo.onclick=e=>{e.preventDefault(),redo()}),window.addEventListener("keydown",(e=>{(e.ctrlKey||e.metaKey)&&("z"===e.key.toLowerCase()&&(e.preventDefault(),undo()),"y"===e.key.toLowerCase()&&(e.preventDefault(),redo()))}))}export function saveState(){if(isLocked||!canvas)return;const json=JSON.stringify(canvas.toJSON());historyIndex>=0&&json===history[historyIndex]||(historyIndex<history.length-1&&(history=history.slice(0,historyIndex+1)),history.push(json),historyIndex=history.length-1,history.length>50&&(history.shift(),historyIndex--),updateButtons())}export function undo(){isLocked||historyIndex<=0||(isLocked=!0,historyIndex--,loadState())}export function redo(){isLocked||historyIndex>=history.length-1||(isLocked=!0,historyIndex++,loadState())}function loadState(){const json=history[historyIndex];canvas.loadFromJSON(json,(()=>{canvas.backgroundColor||canvas.setBackgroundColor("#ffffff"),canvas.renderAll(),canvas.fire("object:modified"),setTimeout((()=>{isLocked=!1,updateButtons()}),100)}))}function updateButtons(){const btnUndo=document.getElementById("btn-undo"),btnRedo=document.getElementById("btn-redo");btnUndo&&(btnUndo.disabled=historyIndex<=0),btnRedo&&(btnRedo.disabled=historyIndex>=history.length-1)}export function resetHistory(){history=[],historyIndex=-1,setTimeout((()=>{saveState()}),200)}