import{getCurrentState,setMode,restorePreviousMode,updateVisualCursor}from"./tools.js";export let canvas=null;const BOARD_SIZE=4e3;let isDragging=!1,lastPosX=0,lastPosY=0;window._isPointerDown=!1;export function initializeCanvas(canvasId,scrollContainerId){document.getElementById(canvasId).oncontextmenu=()=>!1,canvas=new fabric.Canvas(canvasId,{width:4e3,height:4e3,backgroundColor:"#ffffff",isDrawingMode:!1,selection:!0,preserveObjectStacking:!0,fireMiddleClick:!0,stopContextMenu:!0});const scrollArea=document.getElementById(scrollContainerId);return window.addEventListener("keydown",(e=>{if("Space"===e.code&&"INPUT"!==e.target.tagName&&"TEXTAREA"!==e.target.tagName){e.preventDefault();"move"!==getCurrentState().mode&&setMode("move",!0)}}),{capture:!0}),window.addEventListener("keyup",(e=>{"Space"===e.code&&restorePreviousMode()})),canvas.on("mouse:down",(function(opt){const evt=opt.e;window._isPointerDown=!0;const state=getCurrentState();1===evt.button?(evt.preventDefault(),setMode("move",!0),startDragging(evt)):"move"===state.mode&&startDragging(evt)})),canvas.on("mouse:move",(function(opt){if(isDragging&&scrollArea){const evt=opt.e;scrollArea.scrollLeft-=evt.clientX-lastPosX,scrollArea.scrollTop-=evt.clientY-lastPosY,lastPosX=evt.clientX,lastPosY=evt.clientY}updateVisualCursor()})),canvas.on("mouse:up",(function(opt){window._isPointerDown=!1,isDragging=!1,1===opt.e.button&&restorePreviousMode(),updateVisualCursor()})),scrollArea&&setTimeout((()=>{scrollArea.scrollTo({top:(4e3-scrollArea.clientHeight)/2,left:(4e3-scrollArea.clientWidth)/2,behavior:"instant"})}),100),initializeZoomControls(),canvas}function startDragging(evt){isDragging=!0,lastPosX=evt.clientX,lastPosY=evt.clientY,updateVisualCursor()}function initializeZoomControls(){const btnIn=document.getElementById("btn-zoom-in"),btnOut=document.getElementById("btn-zoom-out"),btnReset=document.getElementById("btn-zoom-reset"),updateDisplay=()=>{btnReset&&(btnReset.textContent=Math.round(100*canvas.getZoom())+"%")};canvas.on("mouse:wheel",(function(opt){if(!opt.e.ctrlKey)return;opt.e.preventDefault(),opt.e.stopPropagation();let zoom=canvas.getZoom()*.999**opt.e.deltaY;zoom>5&&(zoom=5),zoom<.1&&(zoom=.1),canvas.zoomToPoint({x:opt.e.offsetX,y:opt.e.offsetY},zoom),updateDisplay()})),btnIn&&(btnIn.onclick=()=>{canvas.setZoom(Math.min(5,1.2*canvas.getZoom())),updateDisplay()}),btnOut&&(btnOut.onclick=()=>{canvas.setZoom(Math.max(.1,.8*canvas.getZoom())),updateDisplay()}),btnReset&&(btnReset.onclick=()=>{canvas.setZoom(1),updateDisplay()})}export function clearCanvas(){confirm("Limpar tudo?")&&(canvas.clear(),canvas.setBackgroundColor("#ffffff",(()=>{canvas.renderAll(),canvas.fire("object:modified")})),canvas.setZoom(1))}