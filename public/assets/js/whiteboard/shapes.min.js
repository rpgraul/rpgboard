import{canvas}from"./canvas.js";import{getCurrentState,setMode}from"./tools.js";let currentShapeType="rect",isDrawing=!1,origX=0,origY=0,activeShape=null;export function initializeShapes(){const shapeBtns=document.querySelectorAll(".shape-option"),shapeGroupBtn=document.getElementById("btn-shape-group"),iconMap={rect:"fa-square",circle:"fa-circle",triangle:"fa-play",arrow:"fa-long-arrow-alt-right"};shapeBtns.forEach((btn=>{btn.addEventListener("click",(e=>{currentShapeType=btn.dataset.shape,document.getElementById("current-shape-icon").className=`fas ${iconMap[currentShapeType]}`,document.getElementById("current-shape-icon").style.transform="triangle"===currentShapeType?"rotate(-90deg)":"",setMode("shape")}))})),shapeGroupBtn.addEventListener("click",(()=>setMode("shape"))),canvas.on("mouse:down",onMouseDown),canvas.on("mouse:move",onMouseMove),canvas.on("mouse:up",onMouseUp)}function onMouseDown(o){const state=getCurrentState(),pointer=canvas.getPointer(o.e);if("text"===state.mode){const text=new fabric.IText("Texto",{left:pointer.x,top:pointer.y,fill:state.color,fontSize:24,fontFamily:"Arial"});return canvas.add(text),canvas.setActiveObject(text),text.enterEditing(),text.selectAll(),void setMode("select")}if("shape"===state.mode){isDrawing=!0,origX=pointer.x,origY=pointer.y;const{color:color,width:width}=state;"rect"===currentShapeType?activeShape=new fabric.Rect({left:origX,top:origY,width:0,height:0,fill:"transparent",stroke:color,strokeWidth:width}):"circle"===currentShapeType?activeShape=new fabric.Circle({left:origX,top:origY,radius:0,fill:"transparent",stroke:color,strokeWidth:width,originX:"center",originY:"center"}):"triangle"===currentShapeType?activeShape=new fabric.Triangle({left:origX,top:origY,width:0,height:0,fill:"transparent",stroke:color,strokeWidth:width}):"arrow"===currentShapeType&&(activeShape=new fabric.Line([origX,origY,origX,origY],{stroke:color,strokeWidth:width,selectable:!1,evented:!1})),activeShape&&canvas.add(activeShape)}}function onMouseMove(o){if(!isDrawing||!activeShape)return;const pointer=canvas.getPointer(o.e);if("arrow"===currentShapeType)activeShape.set({x2:pointer.x,y2:pointer.y});else if("circle"===currentShapeType){const dist=Math.sqrt(Math.pow(pointer.x-origX,2)+Math.pow(pointer.y-origY,2));activeShape.set({radius:dist/2})}else origX>pointer.x&&activeShape.set({left:pointer.x}),origY>pointer.y&&activeShape.set({top:pointer.y}),activeShape.set({width:Math.abs(origX-pointer.x),height:Math.abs(origY-pointer.y)});canvas.renderAll()}function onMouseUp(){if(isDrawing){isDrawing=!1;const{color:color,width:width}=getCurrentState();if("arrow"===currentShapeType&&activeShape){const line=activeShape;canvas.remove(line);const dx=line.x2-line.x1,dy=line.y2-line.y1,angle=Math.atan2(dy,dx)*(180/Math.PI),headLen=15+width,arrowHead=new fabric.Triangle({left:line.x2,top:line.y2,originX:"center",originY:"center",angle:angle+90,width:headLen,height:headLen,fill:color}),arrowLine=new fabric.Line([line.x1,line.y1,line.x2,line.y2],{stroke:color,strokeWidth:width,originX:"center",originY:"center"}),group=new fabric.Group([arrowLine,arrowHead],{selectable:!0});canvas.add(group),canvas.setActiveObject(group)}else activeShape&&(activeShape.setCoords(),canvas.setActiveObject(activeShape));activeShape=null}}