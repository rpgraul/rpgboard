import*as firebaseService from"../modules/firebaseService.js";import{canvas}from"./canvas.js";import{resetHistory}from"./history.js";let saveTimeout,currentBoardId=null,boardList=[],unsubscribeCurrentBoard=null,isReceivingUpdate=!1;export function initializeBoardManager(){const select=document.getElementById("board-select"),btnAdd=document.getElementById("btn-add-board"),btnDel=document.getElementById("btn-del-board");firebaseService.listenToBoards((async snapshot=>{boardList=snapshot.docs.map((doc=>({id:doc.id,...doc.data()})));const prevId=currentBoardId;if(select.innerHTML="",0===boardList.length){const opt=document.createElement("option");return opt.text="Criando Main Whiteboard...",select.add(opt),void await createNewBoard("Main Whiteboard")}boardList.forEach((b=>{const opt=document.createElement("option");opt.value=b.id,opt.textContent=b.name,select.appendChild(opt)})),prevId&&boardList.some((b=>b.id===prevId))?select.value=prevId:boardList.length>0&&!currentBoardId&&(select.value=boardList[0].id,changeBoard(boardList[0].id))})),select.addEventListener("change",(()=>{select.value&&changeBoard(select.value)})),btnAdd.addEventListener("click",(async()=>{const name=prompt("Nome do novo Board:","Novo Whiteboard");name&&await createNewBoard(name)})),btnDel.addEventListener("click",(async()=>{if(currentBoardId&&confirm("Deletar este board para todos?")){const idToDelete=currentBoardId,currentIndex=boardList.findIndex((b=>b.id===idToDelete));let nextId=null;boardList.length>1&&(nextId=currentIndex>0?boardList[currentIndex-1].id:boardList[currentIndex+1].id),await firebaseService.deleteBoard(idToDelete),nextId&&changeBoard(nextId)}}));["object:modified","object:added","object:removed","path:created","object:rotated","object:scaled"].forEach((evt=>{canvas.on(evt,(()=>{isReceivingUpdate||saveToFirebase()}))}))}async function createNewBoard(name){canvas.clear(),canvas.setBackgroundColor("#ffffff",(()=>canvas.renderAll())),canvas.setZoom(1);changeBoard(await firebaseService.saveBoard(null,name,canvas.toJSON()))}function changeBoard(id){currentBoardId===id&&unsubscribeCurrentBoard||(currentBoardId=id,document.getElementById("board-select").value=id,unsubscribeCurrentBoard&&unsubscribeCurrentBoard(),unsubscribeCurrentBoard=firebaseService.listenToCurrentBoard(id,(docSnapshot=>{if(!docSnapshot.exists())return;const serverJson=docSnapshot.data().json,currentJson=JSON.stringify(canvas.toJSON());serverJson&&serverJson!==currentJson&&(isReceivingUpdate=!0,canvas.loadFromJSON(serverJson,(()=>{canvas.backgroundColor||canvas.setBackgroundColor("#ffffff"),canvas.renderAll(),resetHistory(),setTimeout((()=>{isReceivingUpdate=!1}),100)})))})))}function saveToFirebase(){currentBoardId&&!isReceivingUpdate&&(clearTimeout(saveTimeout),saveTimeout=setTimeout((async()=>{const select=document.getElementById("board-select"),name=select.options[select.selectedIndex]?.text||"Board";try{await firebaseService.saveBoard(currentBoardId,name,canvas.toJSON())}catch(e){console.error(e)}}),1e3))}