import{addChatMessage,listenToChat}from"./firebaseService.js";import{processRoll}from"./diceLogic.js";const messagesContainer=()=>document.getElementById("chat-messages"),sidebar=()=>document.getElementById("chat-sidebar"),inputField=()=>document.getElementById("chat-input"),inputForm=()=>document.getElementById("chat-input-area"),closeBtn=()=>document.getElementById("close-chat-btn");function renderMessage(doc){const data=doc.data?doc.data():doc,el=document.createElement("div");el.className="chat-message "+("system"===data.type?"is-system":"is-user");let timeStr="";if(data.createdAt&&data.createdAt.toDate){const date=data.createdAt.toDate();timeStr=` ${String(date.getHours()).padStart(2,"0")}:${String(date.getMinutes()).padStart(2,"0")}`}return el.innerHTML=`\n        <span class="message-sender">${data.sender||"Anônimo"}${timeStr}</span>\n        <span class="message-text">${data.text}</span>\n    `,el}function scrollToBottom(){const el=messagesContainer();el&&setTimeout((()=>{el.scrollTop=el.scrollHeight}),100)}export function toggleChat(){const s=sidebar();if(s){const isHidden=s.classList.contains("is-hidden");if(s.classList.toggle("is-hidden"),isHidden){const input=inputField();input&&setTimeout((()=>input.focus()),100),scrollToBottom(),removeChatNotification()}}}export async function sendMessage(text,user,characterContext=null,macroName=null){if(!text||!user)return;try{await addChatMessage(text,"user",user),scrollToBottom()}catch(err){return void console.error("Erro ao enviar mensagem:",err)}const cleanText=text.trim();(cleanText.startsWith("/r ")||cleanText.startsWith("/roll "))&&processRoll(cleanText,characterContext,user,macroName)}function showChatNotification(){}function removeChatNotification(){}function initNotifications(){const container=messagesContainer();if(!container)return;new MutationObserver((mutations=>{const s=sidebar();s&&s.classList.contains("is-hidden")&&mutations.some((m=>m.addedNodes.length>0))&&showChatNotification()})).observe(container,{childList:!0})}export function initializeChat(){const btnClose=closeBtn();btnClose&&(btnClose.onclick=()=>sidebar()?.classList.add("is-hidden"));const defaultToggleBtn=document.getElementById("toggle-chat-btn");defaultToggleBtn&&(defaultToggleBtn.onclick=toggleChat);const form=inputForm();form&&(form.onsubmit=async e=>{e.preventDefault();const input=inputField();if(!input)return;const text=input.value.trim();if(!text)return;const user=localStorage.getItem("rpgboard_user_name")||"Anônimo";input.value="",await sendMessage(text,user,null)}),listenToChat((snapshot=>{const container=messagesContainer();container&&(container.innerHTML="",snapshot.docs.forEach((doc=>container.appendChild(renderMessage(doc)))),scrollToBottom())})),initNotifications()}export function logSystemMessage(text,senderName="Sistema"){return addChatMessage(text,"system",senderName)}