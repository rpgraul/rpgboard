import*as firebaseService from"./firebaseService.js";const messagesContainer=()=>document.getElementById("chat-messages"),inputForm=()=>document.getElementById("chat-input-area"),inputField=()=>document.getElementById("chat-input"),toggleBtn=()=>document.getElementById("toggle-chat-btn"),closeBtn=()=>document.getElementById("close-chat-btn"),sidebar=()=>document.getElementById("chat-sidebar");let unsubscribeChat=null;function renderMessage(doc){const data=doc.data?doc.data():doc,id=doc.id||data&&data.id||null,el=document.createElement("div");el.className="chat-message";const messageType="system"===data.type?"is-system":"is-user";el.classList.add(messageType);let timeStr="";if(data.createdAt)try{const date=data.createdAt.toDate?data.createdAt.toDate():new Date(data.createdAt),hours=String(date.getHours()).padStart(2,"0");timeStr=` ${hours}:${String(date.getMinutes()).padStart(2,"0")}`}catch(e){}return el.innerHTML=`\n    <span class="message-sender">${data.sender||"Anônimo"}${timeStr}</span>\n    <span class="message-text">${data.text}</span>\n  `,el.dataset.id=id,el}export function logSystemMessage(text){try{return firebaseService.addChatMessage(text,"system","Sistema")}catch(e){console.error("Falha ao enviar mensagem do sistema:",e)}}export function initializeChat(){toggleBtn()&&(toggleBtn().addEventListener("click",(()=>{const s=sidebar();s&&s.classList.toggle("is-hidden")})),closeBtn()&&closeBtn().addEventListener("click",(()=>{const s=sidebar();s&&s.classList.add("is-hidden")})),inputForm()&&inputForm().addEventListener("submit",(async e=>{e.preventDefault();const text=(inputField()&&inputField().value||"").trim();if(!text)return;const sender=localStorage.getItem("rpgboard_user_name")||"Anônimo";inputField().value="";try{await firebaseService.addChatMessage(text,"user",sender)}catch(err){console.error("Erro ao enviar mensagem de chat:",err)}})),unsubscribeChat&&unsubscribeChat(),unsubscribeChat=firebaseService.listenToChat((snapshot=>{const container=messagesContainer();container&&(container.innerHTML="",snapshot.docs.forEach((doc=>{const el=renderMessage(doc);container.appendChild(el)})),container.scrollTop=container.scrollHeight)})))}export default{initializeChat:initializeChat,logSystemMessage:logSystemMessage};