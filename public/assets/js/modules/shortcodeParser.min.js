const ALWAYS_VISIBLE_COMMANDS=["stat"];export function _parseArguments(t){const e=/"([^"]+)"|\S+/g,n=[];let s;for(;null!==(s=e.exec(t));)n.push(s[1]||s[0]);return n}export function _parseKeyValueArgs(t){const e={};return t.forEach((t=>{const n=t.split("=");2===n.length&&(e[n[0].toLowerCase()]=n[1].replace(/^"|"$/g,""))})),e}function formatNumber(t){return"number"!=typeof t&&"string"!=typeof t?t:t.toString().replace(/\B(?=(\d{3})+(?!\d))/g,".")}function _parseStat(t){const e=["left","right","bottom"],n=t.filter((t=>!e.includes(t)));if(0===n.length)return"";const s=t=>{const e=t.match(/(.*?)\s*\((.*?)\)/);if(e){const t=e[1].trim();return`<span class="has-tooltip" data-tooltip="${e[2].trim()}">${t}</span>`}return t||""};if(1===n.length||"null"===n[0].toLowerCase()){return`<div class="shortcode-stat">${s(1===n.length?n[0]:n.slice(1).join(" "))}</div>`}const a=n[n.length-1];return`<div class="shortcode-stat"><strong>${n.slice(0,-1).join(" ")}:</strong> ${s(a)}</div>`}function _parseHp(t,e,n){const s=_parseKeyValueArgs(t),a=parseInt(s.max,10)||100,o=void 0!==s.current?parseInt(s.current,10):a,r=Math.max(0,Math.min(o,a));return`<div class="shortcode-hp" data-item-id="${e}" data-shortcode="${encodeURIComponent(n)}" data-max-hp="${a}"><strong class="hp-label">PV</strong><div class="hp-input-wrapper"><input type="number" class="hp-current-input" value="${r}" max="${a}" min="0"><span class="hp-max-value">/ ${a}</span></div></div>`}export function parseHpShortcode(t){if(!t||!t.conteudo)return"";const e=t.conteudo.match(/\[hp\s+(.*?)\]/);if(e){return _parseHp(_parseArguments(e[1]),t.id,e[0])}return""}function _parseCount(t,e,n){const s=["left","right","bottom"],a=t.includes("checkbox"),o=t.filter((t=>"checkbox"!==t&&!s.includes(t))),r=_parseKeyValueArgs(o.filter((t=>t.includes("="))));let c="number";r.icon?c="custom-icon":r.theme?c=r.theme:a&&(c="default");const i=o.find((t=>!t.includes("=")))||"",l=parseInt(r.max,10)||0;let u=void 0!==r.current?parseInt(r.current,10):l;if(u=Math.max(0,Math.min(u,l)),!i&&0===l)return"";const d=`data-item-id="${e}" data-shortcode="${encodeURIComponent(n)}"`;let p="";if(["default","arrow","potion","custom-icon"].includes(c)&&l>0){p=`<span class="count-checkboxes-interactive theme-${c}">`;for(let t=1;t<=l;t++){const e=t<=u;let n="";if("arrow"===c)n='<i class="fas fa-arrow-up"></i>';else if("potion"===c)n='<i class="fas fa-flask"></i>';else if("custom-icon"===c){n=`<i class="fas fa-${r.icon.replace(/["']/g,"")}"></i>`}p+=`<span class="count-checkbox ${e?"is-checked":""}" data-value="${t}" role="button" tabindex="0">${n}</span>`}p+="</span>"}else p=`\n            <span class="count-value-interactive">\n                <button class="count-btn" data-action="decrement" aria-label="Diminuir">-</button>\n                <span class="count-current-value">${u}</span>\n                <span class="count-separator">/</span>\n                <span class="count-max-value">${l}</span>\n                <button class="count-btn" data-action="increment" aria-label="Aumentar">+</button>\n            </span>\n        `.trim().replace(/\s+/g," ");return p=`<div class="count-representation">${p}</div>`,`<div class="shortcode-count is-interactive" ${d}>${i?`<strong class="count-name">${i}:</strong> `:""}${p}</div>`}export function parseMainContent(t){if(!t)return"";let e=t.replace(/\[(hide|#)\]([\s\S]*?)\[\/(hide|#)\]/gi,((t,e,n,s)=>e.toLowerCase()!==s.toLowerCase()?t:`<div class="content-hidden">${n}</div>`));return e=e.replace(/\[(.*?)\]/g,((t,e)=>{const n=_parseArguments(e)[0]||"",s=n.replace(/^[#*]/,"");return n.startsWith("*")||n.startsWith("#")||ALWAYS_VISIBLE_COMMANDS.includes(s.toLowerCase())||["hp","count","money"].includes(s.toLowerCase())?"":t})),e=e.replace(/\{(.*?)\}/g,((t,e)=>`<span class="card-link" data-card-name="${e.replace(/"/g,"&quot;")}">${e}</span>`)),e=e.trim(),e.replace(/\n/g,"<br>").replace(/(<br>\s*){2,}/g,"<br>")}export function parseAllShortcodes(t,e={}){if(!t||!t.conteudo)return{left:"",right:"",bottom:"",details:""};const n={left:[],right:[],bottom:[],details:[]},s={stat:1,money:2,hp:3,count:4,default:99},a=t.conteudo,o=[],r=/\[(hide|#)\]([\s\S]*?)\[\/(hide|#)\]/gi;let c;for(;null!==(c=r.exec(a));){const[t,e,n,s]=c;if(e.toLowerCase()===s.toLowerCase()){const e=c.index+t.indexOf(n);o.push({start:e,end:e+n.length})}}const i=t=>o.some((e=>t>=e.start&&t<e.end)),l=[],u=/\[(.*?)\]/g;let d;for(;null!==(d=u.exec(a));){const t=d[0],e=_parseArguments(d[1]),n=e[0]||"",s=n.startsWith("#"),a=i(d.index),o=s||a,r=n.replace(/^[#*]+/,"").toLowerCase(),c=e.slice(1);["stat","hp","count","money"].includes(r)&&l.push({command:r,args:c,originalShortcode:t,isHidden:o})}l.sort(((t,e)=>(s[t.command]||s.default)-(s[e.command]||s.default)));const p=(t,e)=>e?`<div class="is-hidden">${t}</div>`:t;return l.forEach((s=>{let a=null;s.args.includes("left")?a="left":s.args.includes("right")?a="right":s.args.includes("bottom")&&(a="bottom");let o="";switch(s.command){case"stat":o=_parseStat(s.args),n[a||"left"].push(p(o,s.isHidden));break;case"hp":o=_parseHp(s.args,t.id,s.originalShortcode),n[a||"bottom"].push(p(o,s.isHidden));break;case"money":const r=_parseKeyValueArgs(s.args),c=parseFloat(r.current)||0;let i=r.currency||"";if(!i){const t=["left","right","bottom"],n=s.args.find((e=>!e.includes("=")&&!t.includes(e)));n?i=n:e.defaultCurrency&&(i=e.defaultCurrency)}const l=formatNumber(c);o=`\n                    <div class="shortcode-money is-interactive" data-item-id="${t.id}" data-shortcode="${encodeURIComponent(s.originalShortcode)}">\n                        <i class="fas fa-coins"></i>\n                        <span class="money-value-display">${l}</span><input type="text" class="money-value-input is-hidden" value="${c}"><span class="money-currency">${i}</span>\n                    </div>\n                `.trim().replace(/\s+/g," "),n[a||"left"].push(p(o,s.isHidden));break;case"count":const u=s.originalShortcode.includes("[*count"),d=_parseCount(s.args,t.id,s.originalShortcode),h=p(d,s.isHidden);u?n[a||"right"].push(h):a?n[a].push(h):n.details.push(h)}})),{left:n.left.join(""),right:n.right.join(""),bottom:n.bottom.join(""),details:n.details.join("")}}