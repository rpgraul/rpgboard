import{sendDiceRoll,addChatMessage}from"./firebaseService.js";export function processRoll(command,character,userName,macroName=null){let formula=command.replace(/^\/(r|roll)\s+/,"").toLowerCase();if(character&&character.conteudo){const tempDiv=document.createElement("div");tempDiv.innerHTML=character.conteudo.replace(/<[^>]+>/g," ");const rawText=tempDiv.textContent,statRegex=/\[stat\s+["']([^"']+)["']\s+["']([^"']+)["']/gi;let match;const stats={};for(;null!==(match=statRegex.exec(rawText));){const key=match[1].toLowerCase(),val=parseInt(match[2],10);isNaN(val)||(stats[key]=val)}Object.keys(stats).forEach((statName=>{const regex=new RegExp(`\\b${statName}\\b`,"g");formula=formula.replace(regex,stats[statName])}))}try{const diceRegex=/(\d+)d(\d+)/g;let evaluatedFormula=formula;const rollsToSend=[];if(evaluatedFormula=evaluatedFormula.replace(diceRegex,((match,qtd,sides)=>{let subTotal=0;const q=parseInt(qtd),s=parseInt(sides);for(let i=0;i<q;i++){const r=Math.floor(Math.random()*s)+1;subTotal+=r,rollsToSend.push({sides:s,result:r})}return subTotal})),!/^[\d\s+\-*/().]+$/.test(evaluatedFormula))throw new Error("Fórmula inválida ou insegura");const totalResult=new Function("return "+evaluatedFormula)(),infoLabel=macroName?`${macroName}: ${totalResult}`:`Total: ${totalResult}`;addChatMessage(macroName?`<strong>${userName}</strong> usou <strong>${macroName}</strong>: ${totalResult} <span style="color:#ccc; font-size:0.8em">(${formula})</span>`:`<strong>${userName}</strong> rolou: ${totalResult} <span style="color:#ccc; font-size:0.8em">(${formula})</span>`,"system","Sistema"),rollsToSend.forEach((roll=>{sendDiceRoll(userName,`d${roll.sides}`,roll.result,infoLabel)}))}catch(e){console.error("Erro na rolagem:",e),addChatMessage(`Erro ao processar: ${formula}`,"system","Sistema")}}