import*as cardManager from"./cardManager.js";import*as shortcodeParser from"./shortcodeParser.js";import*as firebaseService from"./firebaseService.js";let currentPlayerId=null,tiptapEditor=null,cardsCache=[],saveTimeout=null;function storageKeyFor(userName){return`ficha_ID_${userName||"Visitante"}`}export function savePlayerIdForUser(userName,id){userName&&localStorage.setItem(storageKeyFor(userName),id)}export function loadPlayerIdForUser(userName){return userName?localStorage.getItem(storageKeyFor(userName)):null}function filterPJs(items){return items&&items.length?items.filter((i=>(i.tags||[]).some((t=>"pj"===(t||"").toString().toLowerCase())))):[]}function openSelectionModal(pjs,onSelect){const modal=document.createElement("div");modal.className="modal player-select-modal is-active",modal.innerHTML='\n    <div class="modal-background"></div>\n    <div class="modal-card">\n      <header class="modal-card-head"><p class="modal-card-title">Escolha seu PJ</p><button class="delete" aria-label="close"></button></header>\n      <section class="modal-card-body"><div class="content"><ul class="pj-list"></ul></div></section>\n      <footer class="modal-card-foot"><button class="button modal-cancel">Cancelar</button></footer>\n    </div>',document.body.appendChild(modal);const list=modal.querySelector(".pj-list");function closeModal(){modal.remove()}pjs.forEach((p=>{const li=document.createElement("li"),btn=document.createElement("button");btn.className="button is-fullwidth is-light pj-select-btn",btn.textContent=p.titulo||p.id,btn.addEventListener("click",(()=>{onSelect(p),closeModal()})),li.appendChild(btn),list.appendChild(li)})),modal.querySelector(".delete").addEventListener("click",closeModal),modal.querySelector(".modal-cancel").addEventListener("click",closeModal)}function buildSheetUI(item){let container=document.getElementById("player-sheet-container");container&&container.remove(),container=document.createElement("div"),container.id="player-sheet-container",container.className="player-sheet is-active";const header=document.createElement("div");header.className="player-sheet-header",header.innerHTML=`<div class="title">${item.titulo||"Ficha"}</div><div class="actions"><button id="sheet-swap" class="button is-small">Trocar</button><button id="sheet-close" class="button is-small">Fechar</button></div>`;const main=document.createElement("div");main.className="player-sheet-main";const col1=document.createElement("div");col1.className="ps-col ps-col-1";const col2=document.createElement("div");col2.className="ps-col ps-col-2";const col3=document.createElement("div");if(col3.className="ps-col ps-col-3",item.url){const avatar=document.createElement("div");avatar.className="ps-avatar",avatar.innerHTML=`<img src="${item.url}" alt="${item.titulo}">`,col1.appendChild(avatar)}const parsed=shortcodeParser.parseAllShortcodes(item,{defaultCurrency:"¢"}),temp=document.createElement("div");temp.innerHTML=parsed.left+parsed.right+parsed.bottom+parsed.details;const hpEls=temp.querySelectorAll(".shortcode-hp"),countEls=temp.querySelectorAll(".shortcode-count"),vitWrap=document.createElement("div");vitWrap.className="vitality-wrap",hpEls.forEach((e=>vitWrap.appendChild(e.cloneNode(!0)))),countEls.forEach((e=>vitWrap.appendChild(e.cloneNode(!0)))),col1.appendChild(vitWrap);const moneyEls=temp.querySelectorAll(".shortcode-money"),statEls=temp.querySelectorAll(".shortcode-stat"),econWrap=document.createElement("div");econWrap.className="economy-wrap",moneyEls.forEach((e=>econWrap.appendChild(e.cloneNode(!0))));const statsList=document.createElement("div");statsList.className="stats-list",statEls.forEach((e=>statsList.appendChild(e.cloneNode(!0)))),col2.appendChild(econWrap),col2.appendChild(statsList);const editorWrap=document.createElement("div");editorWrap.className="editor-wrap",editorWrap.innerHTML='<div id="player-tiptap-toolbar"></div><div id="player-tiptap-container"></div>',col3.appendChild(editorWrap),main.appendChild(col1),main.appendChild(col2),main.appendChild(col3);const footer=document.createElement("div");footer.className="player-sheet-footer",footer.innerHTML='<div class="dice-buttons"><button class="button is-small roll-dice" data-dice="d20">D20</button><button class="button is-small roll-dice" data-dice="d6">D6</button><button class="button is-small roll-dice" data-dice="d10">D10</button></div><div class="quick-chat"><input class="input is-small" id="player-quick-chat" placeholder="Mensagem rápida..."><button id="player-quick-send" class="button is-small is-primary">Enviar</button></div>',container.appendChild(header),container.appendChild(main),container.appendChild(footer),document.body.appendChild(container),container.querySelector("#sheet-close").addEventListener("click",(()=>{container.classList.remove("is-active"),container.style.display="none"})),container.querySelector("#sheet-swap").addEventListener("click",(()=>{const userName=localStorage.getItem("rpgboard_user_name")||"Visitante";localStorage.removeItem(storageKeyFor(userName)),openSelectionModal(filterPJs(cardsCache),(p=>{currentPlayerId=p.id,savePlayerIdForUser(userName,p.id),buildSheetUI(p),initializeTiptapFor(p)}))})),container.querySelectorAll(".roll-dice").forEach((btn=>{btn.addEventListener("click",(()=>{const diceType=btn.dataset.dice,sides=parseInt(diceType.replace("d",""),10),result=Math.floor(Math.random()*sides)+1,userName=localStorage.getItem("rpgboard_user_name")||"Visitante";firebaseService.sendDiceRoll(userName,diceType,result)}))})),container.querySelector("#player-quick-send").addEventListener("click",(()=>{const input=container.querySelector("#player-quick-chat"),msg=input.value.trim();if(!msg)return;const userName=localStorage.getItem("rpgboard_user_name")||"Visitante";try{window.dispatchEvent(new CustomEvent("playerQuickChat",{detail:{userName:userName,msg:msg}}))}catch(e){}input.value=""})),initializeTiptapFor(item)}async function initializeTiptapFor(item){const container=document.getElementById("player-tiptap-container");if(container)if(tiptapEditor)tiptapEditor.commands.setContent(shortcodeParser.parseMainContent(item.conteudo||""));else try{const[{Editor:Editor},{default:StarterKit}]=await Promise.all([import("https://esm.sh/@tiptap/core@2.2.4"),import("https://esm.sh/@tiptap/starter-kit@2.2.4")]);tiptapEditor=new Editor({element:container,extensions:[StarterKit],content:shortcodeParser.parseMainContent(item.conteudo||""),onUpdate:({editor:editor})=>{saveTimeout&&clearTimeout(saveTimeout),saveTimeout=setTimeout((async()=>{const updatedHtml=editor.getHTML();try{await firebaseService.updateItem({id:item.id},{playerNotes:updatedHtml})}catch(e){console.error("Falha ao salvar notas da ficha:",e)}}),800)}})}catch(e){container.innerHTML=`<div contenteditable="true" class="simple-notes">${shortcodeParser.parseMainContent(item.conteudo||"")}</div>`;const editable=container.querySelector(".simple-notes");editable.addEventListener("input",(()=>{saveTimeout&&clearTimeout(saveTimeout),saveTimeout=setTimeout((async()=>{try{await firebaseService.updateItem({id:item.id},{playerNotes:editable.innerHTML})}catch(e){}}),800)}))}}function onCardsUpdate(newItems){if(cardsCache=newItems,!currentPlayerId)return;const current=cardsCache.find((i=>i.id===currentPlayerId));if(!current)return;const container=document.getElementById("player-sheet-container");if(!container)return;const parsed=shortcodeParser.parseAllShortcodes(current,{defaultCurrency:"¢"}),temp=document.createElement("div");temp.innerHTML=parsed.left+parsed.right+parsed.bottom+parsed.details;const vitWrap=container.querySelector(".vitality-wrap");vitWrap&&(vitWrap.innerHTML="",temp.querySelectorAll(".shortcode-hp").forEach((e=>vitWrap.appendChild(e.cloneNode(!0)))),temp.querySelectorAll(".shortcode-count").forEach((e=>vitWrap.appendChild(e.cloneNode(!0)))));const econWrap=container.querySelector(".economy-wrap"),statsList=container.querySelector(".stats-list");econWrap&&(econWrap.innerHTML="",temp.querySelectorAll(".shortcode-money").forEach((e=>econWrap.appendChild(e.cloneNode(!0))))),statsList&&(statsList.innerHTML="",temp.querySelectorAll(".shortcode-stat").forEach((e=>statsList.appendChild(e.cloneNode(!0)))))}export async function initialize(){cardManager.subscribe(onCardsUpdate),cardsCache=cardManager.getItems()}export function openFicha(){const userName=localStorage.getItem("rpgboard_user_name")||"Visitante",savedId=loadPlayerIdForUser(userName),pjs=filterPJs(cardsCache);if(pjs.length){if(savedId){const item=cardsCache.find((i=>i.id===savedId));if(item)return currentPlayerId=savedId,void buildSheetUI(item)}openSelectionModal(pjs,(p=>{currentPlayerId=p.id,savePlayerIdForUser(userName,p.id),buildSheetUI(p)}))}else alert("Nenhum PJ encontrado. Peça ao narrador para marcar seu personagem com a tag PJ.")}export function getCurrentPlayerId(){return currentPlayerId}