import{Editor}from"@tiptap/core";import StarterKit from"@tiptap/starter-kit";import Highlight from"@tiptap/extension-highlight";import TextAlign from"@tiptap/extension-text-align";import Link from"@tiptap/extension-link";import Underline from"@tiptap/extension-underline";import{listenToItems,updateItem,listenToDiceRolls,addChatMessage}from"./modules/firebaseService.js";import{initializeAuth,getCurrentUserName}from"./modules/auth.js";import{initializeLayout}from"./modules/layout.js";import{uploadImage}from"./imgbbService.js";import{openModal,closeModal,initializeModals}from"./modules/modal.js";import*as shortcodeParser from"./modules/shortcodeParser.js";import*as chat from"./modules/chat.js";import{visualizeDiceRoll}from"./modules/dice3d.js";import{processRoll}from"./modules/diceLogic.js";let imgEl,nameEl,visualStatsContainer,visualCountsContainer,rawContentEditor,notesEditor,allItems=[],currentCharacterId=null,currentCharacter=null,autoSaveTimeout=null,descEditor=null,descEditorSaveTimeout=null,contentEditor=null,contentEditorSaveTimeout=null;function injectSheetLayoutHTML(){const layout=document.querySelector(".sheet-layout");layout&&(layout.innerHTML='\n            <div class="sheet-column column-visual">\n                <div class="box is-full-height">\n                    <div id="char-image-container" class="char-image-container">\n                        <img id="char-image" src="" alt="Personagem">\n                        <label class="image-change-btn" data-tooltip="Trocar Imagem do Personagem">\n                            <i class="fas fa-camera"></i>\n                            <input type="file" id="char-image-upload" class="is-hidden" accept="image/*">\n                        </label>\n                    </div>\n                    <div style="display: flex; align-items: center; gap: 0.5rem; margin-top: 1rem; margin-bottom: 1rem;">\n                        <h2 id="char-name" class="title is-4" style="margin: 0; flex: 1;"></h2>\n                        <button id="edit-content-btn" class="button is-small is-light" data-tooltip="Editar Conteúdo">\n                            <span class="icon is-small"><i class="fas fa-pen"></i></span>\n                        </button>\n                    </div>\n                    <div id="visual-stats-container" class="content mt-4"></div>\n                    <div id="visual-counts-container" class="content mt-4"></div>\n                </div>\n            </div>\n            <div class="sheet-column column-raw-editor">\n                <div class="box is-full-height">\n                    <h3 class="title is-6"><i class="fas fa-align-left"></i> Descrição</h3>\n                    <div id="desc-tiptap-wrapper" class="tiptap-editor-wrapper" style="flex: 1; display: flex; flex-direction: column;">\n                        <div role="toolbar" aria-label="toolbar" class="tiptap-toolbar">\n                            \x3c!-- Toolbar será preenchida pelo JS --\x3e\n                        </div>\n                        <div id="desc-editor" class="tiptap-editor-content" style="flex: 1; overflow-y: auto;"></div>\n                    </div>\n                    <p class="help">Alterações são salvas automaticamente.</p>\n                </div>\n            </div>\n            <div class="sheet-column column-notes">\n                <div class="box is-full-height">\n                    <h3 class="title is-6"><i class="fas fa-sticky-note"></i> Notas Rápidas</h3>\n                    <div class="field is-full-height">\n                        <div class="control is-full-height">\n                            <textarea id="player-notes-editor" class="textarea player-notes-area" placeholder="Suas anotações pessoais (salvas no servidor)..."></textarea>\n                        </div>\n                    </div>\n                </div>\n            </div>\n            <footer class="sheet-footer">\n                <div id="macro-bar" class="macro-bar">\n                    \x3c!-- Botões de Macro serão injetados aqui --\x3e\n                </div>\n                <div class="dice-bar">\n                    <button class="button is-small is-rounded dice-btn" data-dice="d4">d4</button>\n                    <button class="button is-small is-rounded dice-btn" data-dice="d6">d6</button>\n                    <button class="button is-small is-rounded dice-btn" data-dice="d8">d8</button>\n                    <button class="button is-small is-rounded dice-btn" data-dice="d10">d10</button>\n                    <button class="button is-small is-rounded dice-btn" data-dice="d12">d12</button>\n                    <button class="button is-small is-rounded dice-btn" data-dice="d20">d20</button>\n                    <button class="button is-small is-rounded dice-btn" data-dice="d100">d100</button>\n                </div>\n                <div class="chat-input-wrapper">\n                    <input id="sheet-chat-input" class="input is-small" type="text" placeholder="Mensagem ou comando (/r 1d20+5)...">\n                </div>\n            </footer>\n        ')}function checkUrlAndLoad(){const hash=window.location.hash.substring(1);if(hash&&allItems.some((i=>i.id===hash)))loadCharacter(hash);else{const savedId=localStorage.getItem(`sheet_last_char_${getCurrentUserName()}`);savedId&&allItems.find((i=>i.id===savedId))?loadCharacter(savedId):openCharSelection()}}function openCharSelection(){const modal=document.getElementById("char-selection-modal"),container=document.getElementById("char-selection-body");if(!modal||!container)return;const pjs=allItems.filter((i=>i.tags&&i.tags.some((t=>"pj"===t.toLowerCase()))));if(container.innerHTML="",0===pjs.length)container.innerHTML="<p>Nenhum personagem PJ encontrado.</p>";else{const list=document.createElement("div");list.className="buttons",pjs.forEach((pj=>{const btn=document.createElement("button");btn.className="button is-fullwidth is-dark",btn.textContent=pj.titulo,btn.onclick=()=>{closeModal(modal),loadCharacter(pj.id)},list.appendChild(btn)})),container.appendChild(list)}openModal(modal)}function loadCharacter(id){const char=allItems.find((i=>i.id===id));if(char){if(currentCharacterId=id,currentCharacter=char,localStorage.setItem(`sheet_last_char_${getCurrentUserName()}`,id),window.location.hash=id,imgEl&&(imgEl.src=char.url||""),nameEl&&(nameEl.textContent=char.titulo),visualStatsContainer){visualStatsContainer.innerHTML="",visualCountsContainer&&(visualCountsContainer.innerHTML="");const parsed=shortcodeParser.parseAllShortcodes(char,{isPlayerSheet:!0});visualStatsContainer.innerHTML=parsed.all.filter((s=>"stat"===s.type||"money"===s.type)).map((s=>s.html)).join(""),visualCountsContainer&&(visualCountsContainer.innerHTML=parsed.all.filter((s=>"count"===s.type)).map((s=>s.html)).join(""))}rawContentEditor&&document.activeElement!==rawContentEditor&&(rawContentEditor.value=htmlToRaw(char.conteudo||"")),descEditor?descEditor.view?.hasFocus?.()||descEditor.commands.setContent(char.descricao||""):initializeDescEditor().then((()=>{descEditor&&!descEditor.view?.hasFocus?.()&&descEditor.commands.setContent(char.descricao||"")})).catch(console.error),notesEditor&&document.activeElement!==notesEditor&&(notesEditor.value=char.playerNotes||"")}}function htmlToRaw(html){if(!html)return"";let t=html.replace(/<br\s*\/?>/gi,"\n").replace(/<\/p>/gi,"\n\n").replace(/<p>/gi,"").replace(/&nbsp;/gi," ").replace(/<[^>]+>/g,"");const e=document.createElement("textarea");return e.innerHTML=t,e.value.trim()}function setupSheetSpecificListeners(){rawContentEditor&&rawContentEditor.addEventListener("input",(e=>handleAutoSave("conteudo",e.target.value,!0))),notesEditor&&notesEditor.addEventListener("input",(e=>handleAutoSave("playerNotes",e.target.value,!1)));const imgUploadInput=document.getElementById("char-image-upload");imgUploadInput&&imgUploadInput.addEventListener("change",handleCharImageUpload);const editContentBtn=document.getElementById("edit-content-btn");editContentBtn&&editContentBtn.addEventListener("click",openContentEditorModal);const contentEditorModal=document.getElementById("content-editor-modal");if(contentEditorModal){const closeBtn=contentEditorModal.querySelector(".modal-background"),deleteBtn=contentEditorModal.querySelector(".delete"),cancelBtn=contentEditorModal.querySelector(".modal-cancel"),saveBtn=document.getElementById("save-content-btn");closeBtn.addEventListener("click",(()=>closeModal(contentEditorModal))),deleteBtn.addEventListener("click",(()=>closeModal(contentEditorModal))),cancelBtn.addEventListener("click",(()=>closeModal(contentEditorModal))),saveBtn.addEventListener("click",saveContentEditor)}document.querySelectorAll(".dice-btn").forEach((btn=>{btn.addEventListener("click",(()=>{const dice=btn.dataset.dice;if(dice){const user=getCurrentUserName(),cmd=`/r 1${dice}`;addChatMessage(cmd,"user",user),processRoll(cmd,currentCharacter,user,null)}}))}));const quickChatInput=document.getElementById("sheet-chat-input");quickChatInput&&quickChatInput.addEventListener("keydown",(e=>{if("Enter"===e.key){const msg=quickChatInput.value.trim(),user=getCurrentUserName();msg&&(msg.startsWith("/r ")||msg.startsWith("/roll ")?processRoll(msg,currentCharacter,user,null):addChatMessage(msg,"user",user),quickChatInput.value="")}}));const saveMacroBtn=document.getElementById("save-macro-btn");saveMacroBtn&&(saveMacroBtn.onclick=saveMacro),document.querySelectorAll(".shortcode-generator-btn").forEach((btn=>{btn.addEventListener("click",openShortcodeGeneratorModal)}));const shortcodeModal=document.getElementById("shortcode-generator-modal");if(shortcodeModal){const typeSelect=document.getElementById("shortcode-type"),insertBtn=document.getElementById("shortcode-insert-btn"),closeBtn=shortcodeModal.querySelector(".delete"),cancelBtn=shortcodeModal.querySelector(".modal-cancel"),bgBtn=shortcodeModal.querySelector(".modal-background");typeSelect.addEventListener("change",updateShortcodeOptions),insertBtn.addEventListener("click",insertShortcodeFromModal),closeBtn.addEventListener("click",(()=>closeModal(shortcodeModal))),cancelBtn.addEventListener("click",(()=>closeModal(shortcodeModal))),bgBtn.addEventListener("click",(()=>closeModal(shortcodeModal)))}}function handleAutoSave(field,value,isRaw=!1){currentCharacterId&&(clearTimeout(autoSaveTimeout),autoSaveTimeout=setTimeout((()=>{const updateData={};updateData[field]=isRaw?value.replace(/\n/g,"<br>"):value,updateItem({id:currentCharacterId},updateData).catch(console.error)}),1e3))}async function initializeDescEditor(){try{const element=document.querySelector("#desc-editor");if(!element)return void console.warn("Elemento #desc-editor não encontrado");descEditor=new Editor({element:element,extensions:[StarterKit,Highlight,Underline,Link.configure({openOnClick:!1}),TextAlign.configure({types:["heading","paragraph"]})],editorProps:{attributes:{class:"ProseMirror"}},onUpdate:()=>{clearTimeout(descEditorSaveTimeout),descEditorSaveTimeout=setTimeout((()=>{currentCharacterId&&descEditor&&handleDescEditorSave()}),800)}}),setupDescToolbar(descEditor),console.log("Editor de descrição inicializado com sucesso")}catch(error){console.error("Erro ao inicializar editor de descrição:",error)}}function setupDescToolbar(editor){if(!editor)return;const toolbar=document.querySelector("#desc-tiptap-wrapper .tiptap-toolbar");toolbar&&(toolbar.querySelectorAll(".tiptap-button").forEach((btn=>{const action=btn.dataset.action;action&&btn.addEventListener("click",(e=>{e.preventDefault();const level=btn.dataset.level?parseInt(btn.dataset.level):void 0,align=btn.dataset.align;switch(action){case"undo":editor.commands.undo();break;case"redo":editor.commands.redo();break;case"toggleHeading":editor.commands.toggleHeading({level:level});break;case"toggleBulletList":editor.commands.toggleBulletList();break;case"toggleOrderedList":editor.commands.toggleOrderedList();break;case"toggleBold":editor.commands.toggleBold();break;case"toggleItalic":editor.commands.toggleItalic();break;case"toggleStrike":editor.commands.toggleStrike();break;case"toggleHighlight":editor.commands.toggleHighlight();break;case"setTextAlign":editor.commands.setTextAlign(align);break;case"setLink":const url=prompt("URL:");url&&editor.commands.setLink({href:url})}}))})),editor.on("update",(()=>updateDescToolbarButtonStates(editor))),updateDescToolbarButtonStates(editor))}function updateDescToolbarButtonStates(editor){const toolbar=document.querySelector("#desc-tiptap-wrapper .tiptap-toolbar");toolbar&&toolbar.querySelectorAll(".tiptap-button").forEach((btn=>{const action=btn.dataset.action,level=btn.dataset.level?parseInt(btn.dataset.level):void 0,align=btn.dataset.align;let isActive=!1;switch(action){case"toggleHeading":isActive=editor.isActive("heading",{level:level});break;case"toggleBulletList":isActive=editor.isActive("bulletList");break;case"toggleOrderedList":isActive=editor.isActive("orderedList");break;case"toggleBold":isActive=editor.isActive("bold");break;case"toggleItalic":isActive=editor.isActive("italic");break;case"toggleStrike":isActive=editor.isActive("strike");break;case"toggleHighlight":isActive=editor.isActive("highlight");break;case"setTextAlign":isActive=editor.isActive({textAlign:align})}btn.classList.toggle("is-active",isActive)}))}function handleDescEditorSave(){if(!currentCharacterId||!descEditor)return;const html=descEditor.getHTML();updateItem({id:currentCharacterId},{descricao:html}).catch(console.error)}function getMacros(){return JSON.parse(localStorage.getItem(`macros_${getCurrentUserName()}`)||"[]")}function saveMacro(){const n=document.getElementById("macro-name").value.trim(),c=document.getElementById("macro-command").value.trim();if(!n||!c)return;const m=getMacros();m.push({name:n,command:c}),localStorage.setItem(`macros_${getCurrentUserName()}`,JSON.stringify(m)),loadMacros(),closeModal(document.getElementById("macro-modal")),document.getElementById("macro-name").value="",document.getElementById("macro-command").value=""}function loadMacros(){const container=document.getElementById("macro-bar");if(!container)return;container.innerHTML="";const m=getMacros();m.forEach(((mac,i)=>{const b=document.createElement("button");b.className="button is-small is-rounded is-primary is-light",b.textContent=mac.name,b.style.marginRight="5px",b.onclick=()=>{const user=getCurrentUserName();addChatMessage(mac.command,"user",user),processRoll(mac.command,currentCharacter,user,mac.name)},b.oncontextmenu=e=>{e.preventDefault(),confirm("Deletar macro?")&&(m.splice(i,1),localStorage.setItem(`macros_${getCurrentUserName()}`,JSON.stringify(m)),loadMacros())},container.appendChild(b)}))}async function handleCharImageUpload(event){const file=event.target.files[0];if(file&&currentCharacterId)try{imgEl.style.opacity="0.5";const result=await uploadImage(file);await updateItem({id:currentCharacterId},{url:result.url}),imgEl.src=result.url,imgEl.style.opacity="1",event.target.value="",console.log("Imagem atualizada com sucesso")}catch(error){imgEl.style.opacity="1",console.error("Erro ao fazer upload da imagem:",error),alert("Erro ao fazer upload da imagem: "+error.message),event.target.value=""}}function openContentEditorModal(){if(!currentCharacter)return;contentEditor||initializeContentEditor(),contentEditor&&contentEditor.commands.setContent(currentCharacter.conteudo||"");const modal=document.getElementById("content-editor-modal");openModal(modal)}function initializeContentEditor(){try{const element=document.querySelector("#content-editor");if(!element)return void console.warn("Elemento #content-editor não encontrado");contentEditor=new Editor({element:element,extensions:[StarterKit,Highlight,Underline,Link.configure({openOnClick:!1}),TextAlign.configure({types:["heading","paragraph"]})],editorProps:{attributes:{class:"ProseMirror"}},onUpdate:()=>{clearTimeout(contentEditorSaveTimeout)}}),setupContentToolbar(contentEditor),console.log("Editor de conteúdo inicializado com sucesso")}catch(error){console.error("Erro ao inicializar editor de conteúdo:",error)}}function setupContentToolbar(editor){if(!editor)return;const toolbar=document.querySelector("#content-tiptap-wrapper .tiptap-toolbar");toolbar&&(toolbar.querySelectorAll(".tiptap-button").forEach((btn=>{const action=btn.dataset.action;action&&btn.addEventListener("click",(e=>{e.preventDefault();const level=btn.dataset.level?parseInt(btn.dataset.level):void 0,align=btn.dataset.align;switch(action){case"undo":editor.commands.undo();break;case"redo":editor.commands.redo();break;case"toggleHeading":editor.commands.toggleHeading({level:level});break;case"toggleBulletList":editor.commands.toggleBulletList();break;case"toggleOrderedList":editor.commands.toggleOrderedList();break;case"toggleBold":editor.commands.toggleBold();break;case"toggleItalic":editor.commands.toggleItalic();break;case"toggleStrike":editor.commands.toggleStrike();break;case"toggleHighlight":editor.commands.toggleHighlight();break;case"setTextAlign":editor.commands.setTextAlign(align);break;case"setLink":const url=prompt("URL:");url&&editor.commands.setLink({href:url})}}))})),editor.on("update",(()=>updateContentToolbarButtonStates(editor))),updateContentToolbarButtonStates(editor))}function updateContentToolbarButtonStates(editor){const toolbar=document.querySelector("#content-tiptap-wrapper .tiptap-toolbar");toolbar&&toolbar.querySelectorAll(".tiptap-button").forEach((btn=>{const action=btn.dataset.action,level=btn.dataset.level?parseInt(btn.dataset.level):void 0,align=btn.dataset.align;let isActive=!1;switch(action){case"toggleHeading":isActive=editor.isActive("heading",{level:level});break;case"toggleBulletList":isActive=editor.isActive("bulletList");break;case"toggleOrderedList":isActive=editor.isActive("orderedList");break;case"toggleBold":isActive=editor.isActive("bold");break;case"toggleItalic":isActive=editor.isActive("italic");break;case"toggleStrike":isActive=editor.isActive("strike");break;case"toggleHighlight":isActive=editor.isActive("highlight");break;case"setTextAlign":isActive=editor.isActive({textAlign:align})}btn.classList.toggle("is-active",isActive)}))}function saveContentEditor(){if(!currentCharacterId||!contentEditor)return;handleAutoSave("conteudo",contentEditor.getHTML(),!1),closeModal(document.getElementById("content-editor-modal"))}function insertShortcodeInContent(){if(!contentEditor)return;const types=["stat","hp","money","count"];let type=prompt(`Selecione o tipo de shortcode:\n\n${types.join(", ")}`);if(!type||!types.includes(type.toLowerCase()))return void alert("Tipo de shortcode inválido");type=type.toLowerCase();const shortcode={stat:'[stat "atributo" "valor"]',hp:'[hp "valor_atual" "valor_máximo"]',money:'[money "quantidade" "moeda"]',count:'[count "nome" "valor"]'}[type];shortcode&&contentEditor.chain().focus().insertContent(shortcode).run()}function handleShortcodeGeneration(){const contentEditorModal=document.getElementById("content-editor-modal");contentEditorModal&&!1==!contentEditorModal.classList.contains("is-active")&&contentEditor?insertShortcodeInContent():descEditor&&insertShortcodeInDesc()}function insertShortcodeInDesc(){if(!descEditor)return;const types=["stat","hp","money","count"];let type=prompt(`Selecione o tipo de shortcode:\n\n${types.join(", ")}`);if(!type||!types.includes(type.toLowerCase()))return void alert("Tipo de shortcode inválido");type=type.toLowerCase();const shortcode={stat:'[stat "atributo" "valor"]',hp:'[hp "valor_atual" "valor_máximo"]',money:'[money "quantidade" "moeda"]',count:'[count "nome" "valor"]'}[type];shortcode&&descEditor.chain().focus().insertContent(shortcode).run()}function openShortcodeGeneratorModal(){const modal=document.getElementById("shortcode-generator-modal");modal&&(document.getElementById("shortcode-type").value="",document.getElementById("stat-label").value="",document.getElementById("stat-value").value="",document.getElementById("hp-max").value="",document.getElementById("hp-current").value="",document.getElementById("count-label").value="",document.getElementById("count-value").value="",document.getElementById("count-max").value="",document.getElementById("money-value").value="",document.getElementById("money-currency").value="ouro",document.getElementById("nota-titulo").value="",document.getElementById("shortcode-options-stat").classList.add("is-hidden"),document.getElementById("shortcode-options-hp").classList.add("is-hidden"),document.getElementById("shortcode-options-count").classList.add("is-hidden"),document.getElementById("shortcode-options-money").classList.add("is-hidden"),document.getElementById("shortcode-options-nota").classList.add("is-hidden"),openModal(modal))}function updateShortcodeOptions(){const type=document.getElementById("shortcode-type").value;switch(document.getElementById("shortcode-options-stat").classList.add("is-hidden"),document.getElementById("shortcode-options-hp").classList.add("is-hidden"),document.getElementById("shortcode-options-count").classList.add("is-hidden"),document.getElementById("shortcode-options-money").classList.add("is-hidden"),document.getElementById("shortcode-options-nota").classList.add("is-hidden"),type){case"stat":document.getElementById("shortcode-options-stat").classList.remove("is-hidden");break;case"hp":document.getElementById("shortcode-options-hp").classList.remove("is-hidden");break;case"count":document.getElementById("shortcode-options-count").classList.remove("is-hidden");break;case"money":document.getElementById("shortcode-options-money").classList.remove("is-hidden");break;case"nota":document.getElementById("shortcode-options-nota").classList.remove("is-hidden")}}function insertShortcodeFromModal(){const type=document.getElementById("shortcode-type").value;if(!type)return void alert("Selecione um tipo de shortcode");let shortcode="";switch(type){case"stat":shortcode=`[stat "${document.getElementById("stat-label").value||"atributo"}" "${document.getElementById("stat-value").value||"0"}"]`;break;case"hp":shortcode=`[hp max="${document.getElementById("hp-max").value||"100"}" current="${document.getElementById("hp-current").value||"100"}"]`;break;case"count":shortcode=`[count "${document.getElementById("count-label").value||"contador"}" "${document.getElementById("count-value").value||"0"}" max="${document.getElementById("count-max").value||"10"}"]`;break;case"money":shortcode=`[money "${document.getElementById("money-value").value||"0"}" "${document.getElementById("money-currency").value||"ouro"}"]`;break;case"nota":shortcode=`[nota "${document.getElementById("nota-titulo").value||"nota"}"]`}if(!shortcode)return;const contentEditorModal=document.getElementById("content-editor-modal");contentEditorModal&&contentEditorModal.classList.contains("is-active")&&contentEditor?contentEditor.chain().focus().insertContent(shortcode).run():descEditor&&descEditor.chain().focus().insertContent(shortcode).run(),closeModal(document.getElementById("shortcode-generator-modal"))}document.addEventListener("DOMContentLoaded",(async()=>{const layout=await initializeLayout({fabActions:["help","macros","change-char","chat","dice"]});try{const firebaseService=await import("./modules/firebaseService.js"),appSettings=await firebaseService.getSettings();window.appSettings=appSettings,appSettings.siteTitle&&(document.title=`${appSettings.siteTitle} - GameBoard`),"function"==typeof import("./modules/components/header.js").then&&import("./modules/components/header.js").then((mod=>mod.renderHeader&&mod.renderHeader()))}catch(error){console.error("Falha ao carregar configurações do site:",error)}initializeAuth(),initializeModals(),chat.initializeChat(),layout.toggleChatBtn&&layout.toggleChatBtn.addEventListener("click",(e=>{e.preventDefault(),e.stopPropagation(),chat.toggleChat()})),layout.fabHelp&&layout.fabHelp.addEventListener("click",(()=>openModal(layout.helpModal))),layout.fabChangeChar&&layout.fabChangeChar.addEventListener("click",openCharSelection),layout.fabMacros&&layout.fabMacros.addEventListener("click",(()=>openModal(document.getElementById("macro-modal")))),injectSheetLayoutHTML(),imgEl=document.getElementById("char-image"),nameEl=document.getElementById("char-name"),visualStatsContainer=document.getElementById("visual-stats-container"),visualCountsContainer=document.getElementById("visual-counts-container"),rawContentEditor=document.getElementById("raw-content-editor"),notesEditor=document.getElementById("player-notes-editor"),initializeDescEditor().catch(console.error),listenToItems((snapshot=>{allItems=snapshot.docs.map((doc=>({id:doc.id,...doc.data()}))),checkUrlAndLoad()})),listenToDiceRolls((change=>{const rollData=change.doc.data();if(rollData){let cleanType=(rollData.diceType||"").toString().toLowerCase().trim().replace(/^\d+/,"");visualizeDiceRoll(cleanType,rollData.result,rollData.userName,rollData.label)}})),setupSheetSpecificListeners(),loadMacros()}));