import{writeBatch,collection,doc,serverTimestamp}from"https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";import{processImageFromUrl}from"./modules/imgbbService.js";const{db:db}=window.firebaseInstances;document.addEventListener("DOMContentLoaded",(()=>{const e=document.getElementById("json-input"),t=document.getElementById("import-btn"),s=document.getElementById("notification-area");function r(e,t="is-success"){s.innerHTML=`\n      <div class="notification ${t}">\n        <button class="delete"></button>\n        ${e}\n      </div>\n    `;s.querySelector(".delete").addEventListener("click",(()=>{s.innerHTML=""}))}t.addEventListener("click",(async()=>{const o=e.value.trim();if(!o)return void r("O campo de JSON não pode estar vazio.","is-danger");let i;try{i=JSON.parse(o)}catch(e){return void r(`Erro de sintaxe no JSON: ${e.message}`,"is-danger")}if(Array.isArray(i)&&0!==i.length){t.classList.add("is-loading"),s.innerHTML="";try{const t=writeBatch(db),s=collection(db,"rpg-items");for(const e of i){const o=doc(s),i={...e,titulo:e.titulo||"Card Sem Título",conteudo:e.conteudo||"",descricao:e.descricao||"",tags:e.tags||[],isVisibleToPlayers:e.isVisibleToPlayers??!0,createdAt:serverTimestamp(),order:e.order??-Date.now()};if(e.imagem&&"string"==typeof e.imagem){r(`Processando imagem para: ${e.titulo}...`,"is-info");const t=await processImageFromUrl(e.imagem);t&&Object.assign(i,{url:t.url,deleteUrl:t.deleteUrl,width:t.width,height:t.height})}delete i.imagem,delete i.storagePath,t.set(o,i)}await t.commit(),r(`${i.length} card(s) importado(s) com sucesso!`,"is-success"),e.value=""}catch(e){console.error("Erro ao importar cards:",e),r(`Ocorreu um erro durante a importação: ${e.message}`,"is-danger")}finally{t.classList.remove("is-loading")}}else r("O JSON deve ser um array de cards e não pode estar vazio.","is-danger")}))}));