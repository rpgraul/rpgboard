import{initializeModals,openModal,closeModal}from"./modules/modal.js";import*as auth from"./modules/auth.js";import*as firebaseService from"./modules/firebaseService.js";import*as narrator from"./modules/narrator.js";import*as bulkEdit from"./modules/bulkEdit.js";import*as settings from"./modules/settings.js";import*as grid from"./modules/grid.js";import*as board from"./modules/board.js";import*as cardRenderer from"./modules/cardRenderer.js";import*as shortcodeParser from"./modules/shortcodeParser.js";let muuriGrid=null,allItems=[],tagSuggestionsContainer=null,isInitialGridLoaded=!1,appSettings={};const VISIBILITY_FILTERS={VISIBLE:"visible",HIDDEN:"hidden"};function normalizeString(e){return e?e.toString().toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,""):""}function generateTagFilters(e,t){if(!t||!Array.isArray(e))return;const i=t.querySelector(".narrator-only");e.forEach((e=>{const a=document.createElement("div");a.className="control",a.innerHTML=`\n            <label class="checkbox">\n                <input type="checkbox" value="${e.value}">\n                <span>${e.label}</span>\n            </label>\n        `,t.insertBefore(a,i)}))}function injectDragDropStyles(){const e=document.createElement("style");e.textContent='\n        /* Adiciona o cursor de "agarrar" aos cards que podem ser arrastados */\n        .card.muuri-item-draggable {\n            cursor: grab;\n        }\n        .card.muuri-item-dragging {\n            cursor: grabbing;\n        }\n        /* Reseta o cursor para o conteúdo interno, fazendo com que a "alça" seja a borda/padding do card */\n        .card.muuri-item-draggable .card-content,\n        .card.muuri-item-draggable .card-image,\n        .card.muuri-item-draggable .card-actions-top,\n        .card.muuri-item-draggable .card-info-layer {\n            cursor: auto;\n        }\n    ',document.head.appendChild(e)}document.addEventListener("DOMContentLoaded",(async()=>{const e=document.getElementById("fab-toggle-view"),t=document.getElementById("fab-add-card"),i=document.getElementById("fab-help"),a=document.getElementById("fab-bulk-edit"),r=document.getElementById("search-input"),n=document.getElementById("active-filters-container"),s=document.getElementById("clear-filters-btn"),o=document.getElementById("tag-filters"),d=document.getElementById("view-wrapper"),l=document.querySelector(".top-bar-title"),c=(document.getElementById("narrator-login-btn"),document.getElementById("detail-modal")),u=document.getElementById("add-card-modal"),m=document.getElementById("help-modal"),g=document.getElementById("form-add-card"),v=(document.getElementById("fab-settings"),document.getElementById("card-arquivo")),I=document.getElementById("card-tags"),p=document.getElementById("grid-view-container");document.getElementById("board-view-container");injectDragDropStyles();try{appSettings=await firebaseService.getSettings(),l&&(l.textContent=appSettings.siteTitle),document.title=`${appSettings.siteTitle} - GameBoard`,generateTagFilters(appSettings.filters,o)}catch(e){console.error("Falha ao carregar as configurações do site:",e)}function h(){d.classList.contains("view-grid")&&(muuriGrid&&(muuriGrid.destroy(),muuriGrid=null),muuriGrid=new Muuri(p,{items:".card",dragEnabled:!0,dragStartPredicate:function(e,t){const i=e.getElement(),a=t.target;if(bulkEdit.isBulkEditingActive()||i.classList.contains("editing")||i.classList.contains("is-details-visible")||a.closest(".shortcode-hp")||a.closest(".shortcode-count")||a.closest(".shortcode-stat")||a.closest(".toggle-view-icon")||a.closest(".card-actions-top"))return!1;const r=i.getBoundingClientRect(),n=t.srcEvent.clientX||t.clientX,s=t.srcEvent.clientY||t.clientY;return!!(n-r.left<15||r.right-n<15||s-r.top<15||r.bottom-s<15)&&Muuri.ItemDrag.defaultStartPredicate(e,t)}}),muuriGrid.on("dragEnd",(function(e){const t=muuriGrid.getItems().map((e=>e.getElement().dataset.id));firebaseService.updateItemsOrder(t).catch((e=>{console.error("Falha ao reordenar:",e),alert("Não foi possível salvar a nova ordem. A grade será restaurada.")}))})))}async function f(e,t,i,a=null){const r=allItems.find((t=>t.id===e));if(!r||!r.conteudo)return void console.error("Item não encontrado para atualização de shortcode:",e);if(a){const e=a.closest(".shortcode-hp, .shortcode-count");e&&(e.classList.add("is-updating"),setTimeout((()=>e.classList.remove("is-updating")),700))}const n=decodeURIComponent(t);let s;s=/current=/.test(n)?n.replace(/current=(\d+)/,`current=${i}`):n.replace(/\]$/,` current=${i}]`);const o=r.conteudo.replace(n,s);try{await firebaseService.updateItem(r,{conteudo:o})}catch(e){console.error("Falha ao atualizar shortcode:",e),alert("Falha ao salvar a alteração.")}}h(),d.classList.add("view-grid"),auth.initializeAuth(),bulkEdit.initializeBulkEdit(),settings.initializeSettings(),narrator.updateNarratorUI(auth.isNarrator()),window.addEventListener("narratorStatusChange",(()=>{const e=auth.isNarrator();if(narrator.updateNarratorUI(e),e||bulkEdit.exitBulkEditMode(),isInitialGridLoaded){let t=[...allItems];e||(t=t.filter((e=>!1!==e.isVisibleToPlayers))),grid.updateItems(t),h()}}));const b={onDelete:function(e){firebaseService.deleteItem(e).catch((e=>{console.error("Falha ao deletar item no backend:",e),alert("Ocorreu um erro ao deletar o item.")}))},onEdit:function(e,t,i){i.classList.add("is-editing-item"),cardRenderer.renderCardEditMode(e,t,b);const a=e.querySelector(".edit-image-input");a&&a.addEventListener("change",(()=>{if(a.files&&a.files[0]){const t=a.files[0],r=new FileReader,n=e.querySelector(".card-image .image"),s=n.querySelector("img");e.querySelector(".card-image").classList.remove("is-placeholder"),r.onload=e=>{s.src=e.target.result},r.readAsDataURL(t),cardRenderer.getImageDimensions(t).then((e=>{const t=e.height/e.width*100;n.style.paddingBottom=`${t}%`,"grid-view-container"===i.id&&muuriGrid?.layout(!0)})),e._newImageFile=t}}))},onSave:async function(e,t,i){const a=e.querySelector(".save-btn");a.classList.add("is-loading");const r=cardRenderer.getCardFormData(e),n=e._newImageFile||null,s=(t.tags||[]).sort(),o=(r.tags||[]).sort(),d=JSON.stringify(s)!==JSON.stringify(o);if((t.titulo||"")!==r.titulo||(t.conteudo||"")!==r.conteudo||(t.descricao||"")!==r.descricao||d||!1!==t.isVisibleToPlayers!==r.isVisibleToPlayers||n){if(n){const e=await cardRenderer.getImageDimensions(n);r.width=e.width,r.height=e.height}try{await firebaseService.updateItem(t,r,n),i.classList.remove("is-editing-item"),e._newImageFile&&delete e._newImageFile}catch(e){console.error("Falha ao salvar as alterações:",e),alert("Falha ao salvar as alterações."),a.classList.remove("is-loading")}}else i.classList.remove("is-editing-item"),cardRenderer.renderCardViewMode(e,t),e._newImageFile&&delete e._newImageFile,"grid-view-container"===i.id&&muuriGrid?.layout(!0)},onView:w,onTagInputInit:e=>L(e,{suggestions:appSettings.recommendedTags||[]})};function E(){if(!muuriGrid)return;const e=normalizeString(r.value.trim()),t=Array.from(o.querySelectorAll('input:not([value="visible"]):not([value="hidden"]):checked')).map((e=>normalizeString(e.value))),i=o.querySelector(`input[value="${VISIBILITY_FILTERS.VISIBLE}"]`)?.checked,a=o.querySelector(`input[value="${VISIBILITY_FILTERS.HIDDEN}"]`)?.checked;muuriGrid.filter((r=>{const n=r.getElement().dataset.id,s=allItems.find((e=>e.id===n));if(!s)return!1;const o=!e||normalizeString(s.titulo||"").includes(e)||normalizeString(s.conteudo||"").includes(e)||normalizeString(s.descricao||"").includes(e)||s.tags.some((t=>normalizeString(t).includes(e))),d=0===t.length||t.every((e=>s.tags.some((t=>normalizeString(t)===e))));let l=!0;return auth.isNarrator()&&(i||a)&&(i&&!a?l=!1!==s.isVisibleToPlayers:!i&&a&&(l=!1===s.isVisibleToPlayers)),o&&d&&l}))}function y(){const e=""!==r.value.trim(),t=null!==o.querySelector("input:checked");s&&s.classList.toggle("is-hidden",!e&&!t)}function S(){n.innerHTML="";o.querySelectorAll("input:checked").forEach((e=>{const t=document.createElement("div");t.className="tags has-addons",t.innerHTML=`\n                <span class="tag is-link">${e.nextElementSibling.textContent}</span>\n                <a class="tag is-delete" data-value="${e.value}"></a>\n            `,n.appendChild(t)}))}function L(e,t={}){const{isMultiTag:i=!0,suggestions:a=appSettings.recommendedTags||[],showRecsOnFocus:r=!0}=t;tagSuggestionsContainer||(tagSuggestionsContainer=document.createElement("div"),tagSuggestionsContainer.className="tag-suggestions",document.body.appendChild(tagSuggestionsContainer));const n=t=>{if(tagSuggestionsContainer.innerHTML="",0===t.length)return void s();t.forEach((e=>{const t=document.createElement("div");t.className="tag-suggestion-item",t.textContent=e,t.addEventListener("mousedown",(t=>{t.preventDefault(),o(e)})),tagSuggestionsContainer.appendChild(t)}));const i=e.getBoundingClientRect();tagSuggestionsContainer.style.left=`${i.left+window.scrollX}px`,tagSuggestionsContainer.style.top=`${i.bottom+window.scrollY+2}px`,tagSuggestionsContainer.style.width=`${i.width}px`,tagSuggestionsContainer.style.display="block"},s=()=>{tagSuggestionsContainer&&(tagSuggestionsContainer.style.display="none")},o=t=>{if(i){const i=e.value.split(",").map((e=>e.trim()));i[i.length-1]=t,e.value=i.join(", ")+", "}else e.value=t,e.dispatchEvent(new Event("input",{bubbles:!0}));s(),e.focus()};e.addEventListener("focus",(()=>{const t=e.value.trim();r&&(""===t||i&&t.endsWith(","))&&n(a)})),e.addEventListener("input",(()=>{let t;if(i){const i=e.value.split(",").map((e=>e.trim()));t=normalizeString(i[i.length-1])}else t=normalizeString(e.value);if(!t)return void(r?n(a):s());const o=[...new Set(allItems.flatMap((e=>e.tags||[])))].filter((e=>e&&normalizeString(e).includes(t)));n(o)})),e.addEventListener("blur",(()=>setTimeout(s,150)))}function w(e){if(!e||!c)return;const t=c.querySelector(".modal-content");t.innerHTML="";const i=document.createElement("div");i.className="box",i.dataset.itemId=e.id;let a="",r="";if(r+=`<h2 class="title is-3">${e.titulo}</h2>`,e.conteudo){const t=shortcodeParser.parseAllShortcodes(e),i=(t.left||"")+(t.right||"")+(t.bottom||"")+(t.details||"");i&&(r+=`<div class="content modal-shortcodes">${i}</div>`)}if(e.descricao&&(r+=`<hr><div class="content is-small"><strong>Descrição:</strong><br>${e.descricao.replace(/\n/g,"<br>")}</div>`),e.url){a=`<div class="modal-image-container"><img src="${e.url}" alt="${e.titulo}"></div>`;const t=e.height>e.width;i.classList.add(t?"is-layout-vertical":"is-layout-horizontal")}else i.classList.add("is-layout-horizontal");i.innerHTML=`${a}<div class="modal-text-container">${r}</div>`,t.appendChild(i),openModal(c)}initializeModals(),grid.initializeGrid(b),board.initializeBoard(b),document.body.addEventListener("click",(e=>{const t=e.target,i=t.closest(".count-btn, .count-checkbox");if(i){e.stopPropagation();const t=i.closest(".shortcode-count");if(!t)return;const{itemId:a,shortcode:r}=t.dataset;if(a&&r){const e=decodeURIComponent(r),t=e.match(/max=(\d+)/),n=e.match(/current=(\d+)/),s=t?parseInt(t[1],10):0;let o,d=n?parseInt(n[1],10):s;if(i.classList.contains("count-btn")){o="increment"===i.dataset.action?d+1:d-1}else o=parseInt(i.dataset.value,10),o===d&&(o=0);f(a,r,Math.max(0,Math.min(o,s)),i)}return}const a=t.closest(".toggle-view-icon, .tooltip-close-btn");if(a){const e=a.closest(".card");e&&e.classList.toggle("is-details-visible")}else if(bulkEdit.isBulkEditingActive()){const e=t.closest(".card");if(e)return void bulkEdit.toggleCardSelection(e)}})),a&&a.addEventListener("click",bulkEdit.enterBulkEditMode),i&&i.addEventListener("click",(()=>openModal(m))),document.addEventListener("keydown",(e=>{if("Escape"===e.key){if(bulkEdit.isBulkEditingActive())return void bulkEdit.exitBulkEditMode();const e=document.querySelector(".modal.is-active");if(e)return void closeModal(e);const t=document.querySelector(".is-editing-item");if(t){const e=t.querySelector(".card.editing"),i=e?.querySelector(".cancel-btn");return void(i&&i.click())}const i=document.querySelector(".card.is-details-visible");if(i)return void i.classList.remove("is-details-visible")}})),document.body.addEventListener("change",(e=>{const t=e.target;if(t.classList.contains("hp-current-input")){const e=t.closest(".shortcode-hp");if(!e)return;const{itemId:i,shortcode:a,maxHp:r}=e.dataset,n=parseInt(t.value,10);if(!i||!a||isNaN(n))return;const s=Math.max(0,Math.min(n,parseInt(r,10)));s!==n&&(t.value=s),f(i,a,s,t)}})),firebaseService.listenToItems((e=>{if(!isInitialGridLoaded){let t=e.docs.map((e=>({id:e.id,...e.data()})));return auth.isNarrator()||(t=t.filter((e=>!1!==e.isVisibleToPlayers))),allItems=t,allItems.sort(((e,t)=>(e.order||0)-(t.order||0))),grid.updateItems(allItems),board.renderBoardItems(allItems),h(),void(isInitialGridLoaded=!0)}let t=!1;if(e.docChanges().forEach((e=>{const i={id:e.doc.id,...e.doc.data()},a=!1!==i.isVisibleToPlayers,r=allItems.findIndex((e=>e.id===i.id)),n=r>-1;switch(e.type){case"added":if((auth.isNarrator()||a)&&(allItems.push(i),muuriGrid)){const t=cardRenderer.createCardElement(i);muuriGrid.add(t,{index:e.newIndex})}break;case"modified":{const e=p.querySelector(`.card[data-id="${i.id}"]`);if(auth.isNarrator())n?(allItems[r].order!==i.order&&(t=!0),allItems[r]=i):(allItems.push(i),t=!0),e&&cardRenderer.renderCardViewMode(e,i);else if(a&&!n?(allItems.push(i),muuriGrid&&muuriGrid.add(cardRenderer.createCardElement(i)),t=!0):!a&&n?(allItems.splice(r,1),muuriGrid&&e&&muuriGrid.remove([e],{removeElements:!0})):a&&n&&(allItems[r].order!==i.order&&(t=!0),allItems[r]=i,e&&cardRenderer.renderCardViewMode(e,i)),c.classList.contains("is-active")){const e=c.querySelector(".box");e&&e.dataset.itemId===i.id&&w(i)}break}case"removed":{const e=muuriGrid?.getItems().find((e=>e.getElement().dataset.id===i.id));e&&muuriGrid.remove([e],{removeElements:!0}),allItems=allItems.filter((e=>e.id!==i.id));break}}})),allItems.sort(((e,t)=>(e.order||0)-(t.order||0))),t&&muuriGrid){const e=allItems.map((e=>muuriGrid.getItems().find((t=>t.getElement().dataset.id===e.id)))).filter(Boolean);e.length>0&&muuriGrid.sort(e,{layout:"instant"})}board.renderBoardItems(allItems)})),r.addEventListener("input",(()=>{E(),y()})),o.addEventListener("change",(e=>{if("checkbox"===e.target.type){const t=e.target,i=t.value;if(auth.isNarrator()&&(i===VISIBILITY_FILTERS.VISIBLE||i===VISIBILITY_FILTERS.HIDDEN)&&t.checked){const e=i===VISIBILITY_FILTERS.VISIBLE?VISIBILITY_FILTERS.HIDDEN:VISIBILITY_FILTERS.VISIBLE,t=o.querySelector(`input[value="${e}"]`);t&&t.checked&&(t.checked=!1,t.closest("label").classList.remove("is-active"))}t.closest("label").classList.toggle("is-active",t.checked),E(),S(),y()}})),n.addEventListener("click",(e=>{if(e.target.classList.contains("is-delete")){const t=e.target.dataset.value,i=o.querySelector(`input[value="${t}"]`);i&&(i.checked=!1,i.dispatchEvent(new Event("change",{bubbles:!0})))}})),s&&s.addEventListener("click",(()=>{r.value="";o.querySelectorAll('input[type="checkbox"]').forEach((e=>{e.checked=!1,e.closest("label").classList.remove("is-active")})),E(),S(),y()})),t.addEventListener("click",(()=>{g.reset(),grid.updateFileName(v);const e=document.getElementById("card-visibility");auth.isNarrator()&&e&&(e.checked=!1),openModal(u)})),g.addEventListener("submit",(async e=>{e.preventDefault();const t=g.closest(".modal-card").querySelector('button[type="submit"]');t.classList.add("is-loading");const i=v.files.length>0?v.files[0]:null,a=document.getElementById("card-visibility"),r={titulo:document.getElementById("card-titulo").value,conteudo:document.getElementById("card-conteudo").value,descricao:document.getElementById("card-descricao").value,tags:I.value.split(",").map((e=>e.trim())).filter(Boolean),isVisibleToPlayers:!auth.isNarrator()||!a||a.checked};try{if(i){const e=await cardRenderer.getImageDimensions(i);r.width=e.width,r.height=e.height}await firebaseService.addItem(r,i),g.reset(),grid.updateFileName(v),closeModal(u)}catch(e){console.error("Erro ao adicionar novo card:",e),alert("Falha ao adicionar o novo card.")}finally{t.classList.remove("is-loading")}})),v.addEventListener("change",(()=>grid.updateFileName(v))),e.addEventListener("click",(()=>{const t=e.querySelector(".icon i");d.classList.contains("view-board")?(document.body.classList.remove("body-view-board"),d.classList.remove("view-board"),d.classList.add("view-grid"),e.title="Mudar para Visualização em Board",t.className="fas fa-project-diagram",h()):(document.body.classList.add("body-view-board"),d.classList.remove("view-grid"),d.classList.add("view-board"),e.title="Mudar para Visualização em Grade",t.className="fas fa-th",muuriGrid&&(muuriGrid.destroy(),muuriGrid=null))})),L(I,{suggestions:appSettings.recommendedTags||[]}),L(r,{isMultiTag:!1,showRecsOnFocus:!1})}));