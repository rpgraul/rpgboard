import{initializeModals,openModal,closeModal}from"./modules/modal.js";import*as auth from"./modules/auth.js";import*as firebaseService from"./modules/firebaseService.js";import*as narrator from"./modules/narrator.js";import*as bulkEdit from"./modules/bulkEdit.js";import*as settings from"./modules/settings.js";import*as grid from"./modules/grid.js";import*as cardRenderer from"./modules/cardRenderer.js";import*as shortcodeParser from"./modules/shortcodeParser.js";import*as diceRoller from"./modules/diceRoller.js";import*as chat from"./modules/chat.js";async function fetchRandomFantasyName(){try{const response=await fetch("https://gist.githubusercontent.com/tkfu/9819e4ac6d529e225e9fc58b358c3479/raw/srd_5e_monsters.json");if(!response.ok)throw new Error("Falha ao buscar nomes");const data=await response.json();return data[Math.floor(Math.random()*data.length)].name}catch(error){console.warn("Usando nome de fallback:",error);const fallbacks=["Viajante Desconhecido","Aventureiro Solitário","Herói Esquecido","Bardo Anônimo"];return fallbacks[Math.floor(Math.random()*fallbacks.length)]}}let allItems=[],tagSuggestionsContainer=null,isInitialGridLoaded=!1,appSettings={};const VISIBILITY_FILTERS={VISIBLE:"visible",HIDDEN:"hidden"};function normalizeString(str){return str?str.toString().toLowerCase().normalize("NFD").replace(/[̀-ͯ]/g,""):""}function generateTagFilters(filters,container){if(!container||!Array.isArray(filters))return;const firstNarratorFilter=container.querySelector(".narrator-only");filters.forEach((filter=>{const controlDiv=document.createElement("div");controlDiv.className="control",controlDiv.innerHTML=`\n            <label class="checkbox">\n                <input type="checkbox" value="${filter.value}">\n                <span>${filter.label}</span>\n            </label>\n        `,container.insertBefore(controlDiv,firstNarratorFilter)}))}function injectDragDropStyles(){const style=document.createElement("style");style.textContent='\n        /* Adiciona o cursor de "agarrar" aos cards que podem ser arrastados */\n        .card.muuri-item-draggable {\n            cursor: grab;\n        }\n        .card.muuri-item-dragging {\n            cursor: grabbing;\n        }\n        /* Reseta o cursor para o conteúdo interno, fazendo com que a "alça" seja a borda/padding do card */\n        .card.muuri-item-draggable .card-content,\n        .card.muuri-item-draggable .card-image,\n        .card.muuri-item-draggable .card-actions-top,\n        .card.muuri-item-draggable .card-info-layer {\n            cursor: auto;\n        }\n    ',document.head.appendChild(style)}import*as cardManager from"./modules/cardManager.js";async function updateUserState(userName){const loginBtn=document.getElementById("user-login-btn"),userNameSpan=document.getElementById("user-name");if(userName){localStorage.setItem("rpgboard_user_name",userName),loginBtn.style.display="none",userNameSpan.textContent=userName,userNameSpan.style.display="inline";try{await firebaseService.saveUser(userName)}catch(error){console.error("Erro ao salvar usuário no Firebase:",error)}}else localStorage.removeItem("rpgboard_user_name"),loginBtn.style.display="inline-flex",userNameSpan.style.display="none"}document.addEventListener("DOMContentLoaded",(async()=>{let savedUserName=localStorage.getItem("rpgboard_user_name");savedUserName||(savedUserName=await fetchRandomFantasyName(),localStorage.setItem("rpgboard_user_name",savedUserName)),updateUserState(savedUserName);const addCardButton=document.getElementById("fab-add-card"),fabHelp=document.getElementById("fab-help"),fabBulkEdit=document.getElementById("fab-bulk-edit"),searchInput=document.getElementById("search-input"),activeFiltersContainer=document.getElementById("active-filters-container"),clearFiltersBtn=document.getElementById("clear-filters-btn"),tagFiltersContainer=document.getElementById("tag-filters"),viewWrapper=document.getElementById("view-wrapper"),topBarTitle=document.querySelector(".top-bar-title"),detailModal=(document.getElementById("narrator-login-btn"),document.getElementById("detail-modal")),addCardModal=document.getElementById("add-card-modal"),helpModal=document.getElementById("help-modal"),formAddCard=document.getElementById("form-add-card"),cardFileInput=(document.getElementById("fab-settings"),document.getElementById("card-arquivo")),cardTagsInput=document.getElementById("card-tags"),gridViewContainer=document.getElementById("grid-view-container"),userLoginBtn=document.getElementById("user-login-btn"),userLoginModal=document.getElementById("user-login-modal"),formUserLogin=document.getElementById("form-user-login"),userNameInput=document.getElementById("user-name-input"),rollDiceBtn=document.getElementById("roll-dice-btn"),diceModal=document.getElementById("dice-modal"),diceOptions=document.querySelectorAll(".dice-option");userLoginBtn.addEventListener("click",(()=>{openModal(userLoginModal)})),formUserLogin.addEventListener("submit",(e=>{e.preventDefault();const userName=userNameInput.value.trim();userName&&(updateUserState(userName),closeModal(userLoginModal),userNameInput.value="")})),rollDiceBtn.addEventListener("click",(()=>{openModal(diceModal)})),diceOptions.forEach((option=>{option.addEventListener("click",(()=>{const sides=parseInt(option.dataset.dice.replace("d","")),result=diceRoller.rollDice(sides),userName=localStorage.getItem("rpgboard_user_name")||"Visitante";diceRoller.showDiceResult(result,userName),closeModal(diceModal)}))})),injectDragDropStyles();try{appSettings=await firebaseService.getSettings(),topBarTitle&&(topBarTitle.textContent=appSettings.siteTitle),document.title=`${appSettings.siteTitle} - GameBoard`,cardRenderer.initializeCardRenderer(appSettings),generateTagFilters(appSettings.filters,tagFiltersContainer)}catch(error){console.error("Falha ao carregar as configurações do site:",error)}viewWrapper.classList.add("view-grid"),await auth.initializeAuth(),await cardManager.initialize({onDelete:handleDeleteItem,onEdit:handleEditCard,onSave:handleSaveCard,onView:showDetailModal,onTagInputInit:inputElement=>initializeTagInput(inputElement,{suggestions:appSettings.recommendedTags||[]}),gridContainer:gridViewContainer});try{chat.initializeChat()}catch(e){}function updateMasterView(isNarrator){narrator.updateNarratorUI(isNarrator),document.body.classList.toggle("master-view",isNarrator)}function handleEditCard(card,item,container){container.classList.add("is-editing-item"),cardRenderer.renderCardEditMode(card,item,cardActionHandlers);const imageInput=card.querySelector(".edit-image-input");imageInput&&imageInput.addEventListener("change",(()=>{if(imageInput.files&&imageInput.files[0]){const file=imageInput.files[0],reader=new FileReader,figure=card.querySelector(".card-image .image"),img=figure.querySelector("img");card.querySelector(".card-image").classList.remove("is-placeholder"),reader.onload=e=>{img.src=e.target.result},reader.readAsDataURL(file),cardRenderer.getImageDimensions(file).then((dimensions=>{const newAspectRatio=dimensions.height/dimensions.width*100;figure.style.paddingBottom=`${newAspectRatio}%`,grid.refreshLayout()})),card._newImageFile=file}}))}async function handleSaveCard(cardElement,item){const updatedData=cardRenderer.getCardFormData(cardElement),newImageFile=cardElement._newImageFile||null;try{if(newImageFile){const dimensions=await cardRenderer.getImageDimensions(newImageFile);updatedData.width=dimensions.width,updatedData.height=dimensions.height}await firebaseService.updateItem(item,updatedData,newImageFile),cardElement._newImageFile&&delete cardElement._newImageFile;try{const userName=localStorage.getItem("rpgboard_user_name")||"Visitante";chat.logSystemMessage(`${userName} atualizou o card "${updatedData.titulo||item.titulo}"`)}catch(e){}return{...item,...updatedData}}catch(error){throw console.error("Falha ao salvar as alterações:",error),alert("Falha ao salvar as alterações."),error}}async function handleShortcodeValueChange(itemId,encodedShortcode,newCurrentValue,triggerElement=null){const item=allItems.find((i=>i.id===itemId));if(!item||!item.conteudo)return void console.error("Item não encontrado para atualização de shortcode:",itemId);if(triggerElement){const componentRoot=triggerElement.closest(".shortcode-hp, .shortcode-count");componentRoot&&(componentRoot.classList.add("is-updating"),setTimeout((()=>componentRoot.classList.remove("is-updating")),700))}const decodedShortcode=decodeURIComponent(encodedShortcode);let newShortcode;newShortcode=/current=/.test(decodedShortcode)?decodedShortcode.replace(/current=("|)(\d+)("|)/,`current="${newCurrentValue}"`):decodedShortcode.replace(/]$/,` current="${newCurrentValue}"]`);const newContent=item.conteudo.replace(decodedShortcode,newShortcode);try{await firebaseService.updateItem(item,{conteudo:newContent})}catch(error){console.error("Falha ao atualizar shortcode:",error),alert("Falha ao salvar a alteração.")}}auth.initializeAuth(),bulkEdit.initializeBulkEdit(),settings.initializeSettings(),updateMasterView(auth.isNarrator()),window.addEventListener("narratorStatusChange",(()=>{const isNarrator=auth.isNarrator();updateMasterView(isNarrator),isNarrator||bulkEdit.exitBulkEditMode(),applyFilters()}));const cardActionHandlers={onDelete:handleDeleteItem,onEdit:handleEditCard,onSave:handleSaveCard,onView:showDetailModal,onTagInputInit:inputElement=>initializeTagInput(inputElement,{suggestions:appSettings.recommendedTags||[]}),onPositionChange:async function(itemId,position){await firebaseService.updateItem({id:itemId},{boardPosition:position})},onReorder:async function(orderedIds){try{await firebaseService.updateItemsOrder(orderedIds)}catch(error){console.error("Failed to update card order:",error),alert("Failed to save the new card order.")}}};function applyFilters(){const searchTerm=searchInput.value.trim(),selectedTags=Array.from(tagFiltersContainer.querySelectorAll('input:not([value="visible"]):not([value="hidden"]):checked')).map((checkbox=>checkbox.value)),normalizedSearchTerm=normalizeString(searchTerm),visibilityFilters_visible=tagFiltersContainer.querySelector(`input[value="${VISIBILITY_FILTERS.VISIBLE}"]`)?.checked,visibilityFilters_hidden=tagFiltersContainer.querySelector(`input[value="${VISIBILITY_FILTERS.HIDDEN}"]`)?.checked,loadingIndicator=document.querySelector(".loading-indicator");loadingIndicator&&loadingIndicator.remove();const filteredItems=allItems.filter((dataItem=>{const textMatch=!normalizedSearchTerm||normalizeString(dataItem.titulo||"").includes(normalizedSearchTerm)||normalizeString(dataItem.conteudo||"").includes(normalizedSearchTerm)||normalizeString(dataItem.descricao||"").includes(normalizedSearchTerm)||dataItem.tags.some((tag=>normalizeString(tag).includes(normalizedSearchTerm))),tagMatch=0===selectedTags.length||selectedTags.every((selectedTag=>dataItem.tags.some((itemTag=>normalizeString(itemTag)===selectedTag))));let visibilityMatch=!0;return auth.isNarrator()&&(visibilityFilters_visible||visibilityFilters_hidden)&&(visibilityFilters_visible&&!visibilityFilters_hidden?visibilityMatch=!1!==dataItem.isVisibleToPlayers:!visibilityFilters_visible&&visibilityFilters_hidden&&(visibilityMatch=!1===dataItem.isVisibleToPlayers)),textMatch&&tagMatch&&visibilityMatch}));viewWrapper.classList.contains("view-grid")&&grid.setItems(filteredItems,selectedTags)}function updateClearButtonVisibility(){const isSearchActive=""!==searchInput.value.trim(),areFiltersActive=null!==tagFiltersContainer.querySelector("input:checked");clearFiltersBtn&&clearFiltersBtn.classList.toggle("is-hidden",!isSearchActive&&!areFiltersActive)}function updateActiveFiltersDisplay(){activeFiltersContainer.innerHTML="";tagFiltersContainer.querySelectorAll("input:checked").forEach((checkbox=>{const tagPill=document.createElement("div");tagPill.className="tags has-addons",tagPill.innerHTML=`\n                <span class="tag is-link">${checkbox.nextElementSibling.textContent}</span>\n                <a class="tag is-delete" data-value="${checkbox.value}"></a>\n            `,activeFiltersContainer.appendChild(tagPill)}))}function initializeTagInput(inputElement,options={}){const{isMultiTag:isMultiTag=!0,suggestions:suggestions=appSettings.recommendedTags||[],showRecsOnFocus:showRecsOnFocus=!0}=options;tagSuggestionsContainer||(tagSuggestionsContainer=document.createElement("div"),tagSuggestionsContainer.className="tag-suggestions",document.body.appendChild(tagSuggestionsContainer));const showSuggestions=suggestions=>{if(tagSuggestionsContainer.innerHTML="",0===suggestions.length)return void hideSuggestions();suggestions.forEach((tag=>{const item=document.createElement("div");item.className="tag-suggestion-item",item.textContent=tag,item.addEventListener("mousedown",(e=>{e.preventDefault(),selectSuggestion(tag)})),tagSuggestionsContainer.appendChild(item)}));const inputRect=inputElement.getBoundingClientRect();tagSuggestionsContainer.style.left=`${inputRect.left+window.scrollX}px`,tagSuggestionsContainer.style.top=`${inputRect.bottom+window.scrollY+2}px`,tagSuggestionsContainer.style.width=`${inputRect.width}px`,tagSuggestionsContainer.style.display="block"},hideSuggestions=()=>{tagSuggestionsContainer&&(tagSuggestionsContainer.style.display="none")},selectSuggestion=tag=>{if(isMultiTag){const parts=inputElement.value.split(",").map((p=>p.trim()));parts[parts.length-1]=tag,inputElement.value=parts.join(", ")+", "}else inputElement.value=tag,inputElement.dispatchEvent(new Event("input",{bubbles:!0}));hideSuggestions(),inputElement.focus()};inputElement.addEventListener("focus",(()=>{const value=inputElement.value.trim();showRecsOnFocus&&(""===value||isMultiTag&&value.endsWith(","))&&showSuggestions(suggestions)})),inputElement.addEventListener("input",(()=>{let currentTyping;if(isMultiTag){const parts=inputElement.value.split(",").map((p=>p.trim()));currentTyping=normalizeString(parts[parts.length-1])}else currentTyping=normalizeString(inputElement.value);if(!currentTyping)return void(showRecsOnFocus?showSuggestions(suggestions):hideSuggestions());const autocompleteSuggestions=[...new Set(allItems.flatMap((item=>item.tags||[])))].filter((tag=>tag&&normalizeString(tag).includes(currentTyping)));showSuggestions(autocompleteSuggestions)})),inputElement.addEventListener("blur",(()=>setTimeout(hideSuggestions,150)))}function showDetailModal(item){if(!item||!detailModal)return;const modalContent=detailModal.querySelector(".modal-content");modalContent.innerHTML="";const box=document.createElement("div");box.className="box",box.dataset.itemId=item.id;let imageHTML="",textHTML="";if(textHTML+=`<h2 class="title is-3">${item.titulo}</h2>`,item.conteudo){const parsed=shortcodeParser.parseAllShortcodes(item),allShortcodes=(parsed.left||"")+(parsed.right||"")+(parsed.bottom||"")+(parsed.details||"");allShortcodes&&(textHTML+=`<div class="content modal-shortcodes">${allShortcodes}</div>`)}if(item.descricao&&(textHTML+=`<hr><div class="content is-small"><strong>Descrição:</strong><br>${item.descricao.replace(/\n/g,"<br>")}\n</div>`),item.url){imageHTML=`<div class="modal-image-container"><img src="${item.url}" alt="${item.titulo}"></div>`;const isVertical=item.height>item.width;box.classList.add(isVertical?"is-layout-vertical":"is-layout-horizontal")}else box.classList.add("is-layout-horizontal");box.innerHTML=`${imageHTML}<div class="modal-text-container">${textHTML}</div>`,modalContent.appendChild(box),openModal(detailModal)}function handleDeleteItem(item){firebaseService.deleteItem(item).then((()=>{try{const userName=localStorage.getItem("rpgboard_user_name")||"Visitante";chat.logSystemMessage(`${userName} deletou o card "${item.titulo||item.id}"`)}catch(e){}})).catch((err=>{console.error("Falha ao deletar item no backend:",err),alert("Ocorreu um erro ao deletar o item.")}))}initializeModals(),grid.initializeGrid(cardActionHandlers),document.body.addEventListener("click",(event=>{const target=event.target,activeMoneyInput=document.querySelector(".money-value-input:not(.is-hidden)");if(activeMoneyInput&&!activeMoneyInput.contains(target)&&!target.closest(".shortcode-money")){const display=activeMoneyInput.closest(".shortcode-money").querySelector(".money-value-display");activeMoneyInput.classList.add("is-hidden"),display.classList.remove("is-hidden")}const cardLink=target.closest(".card-link");if(cardLink){event.stopPropagation();const cardNameToFind=cardLink.dataset.cardName;if(cardNameToFind){const normalizedCardNameToFind=normalizeString(cardNameToFind),foundCard=allItems.find((item=>normalizeString(item.titulo)===normalizedCardNameToFind));foundCard&&showDetailModal(foundCard)}return}const countTrigger=target.closest(".count-btn, .count-checkbox");if(countTrigger){event.stopPropagation();const countComponent=countTrigger.closest(".shortcode-count");if(!countComponent)return;const{itemId:itemId,shortcode:shortcode}=countComponent.dataset;if(itemId&&shortcode){const decodedShortcode=decodeURIComponent(shortcode),maxMatch=decodedShortcode.match(/max=(?:'|')?(\d+)(?:'|')?/),currentMatch=decodedShortcode.match(/current=(?:'|')?(\d+)(?:'|')?/),max=maxMatch?parseInt(maxMatch[1],10):0;let current=currentMatch?parseInt(currentMatch[1],10):0,newCurrent=current;if(countTrigger.classList.contains("count-btn")){const action=countTrigger.dataset.action;"increment"===action?newCurrent=Math.min(current+1,max):"decrement"===action&&(newCurrent=Math.max(current-1,0))}else if(countTrigger.classList.contains("count-checkbox")){const clickedValue=parseInt(countTrigger.dataset.value,10);newCurrent=clickedValue===current?0:clickedValue}handleShortcodeValueChange(itemId,shortcode,newCurrent,countTrigger)}return}const moneyDisplay=target.closest(".shortcode-money .money-value-display");if(moneyDisplay){event.stopPropagation();const input=moneyDisplay.closest(".shortcode-money").querySelector(".money-value-input");return moneyDisplay.classList.add("is-hidden"),input.classList.remove("is-hidden"),input.focus(),void input.select()}if(bulkEdit.isBulkEditingActive()){const cardElement=target.closest(".card");if(cardElement)return void bulkEdit.toggleCardSelection(cardElement)}const clickedTag=target.closest(".card .tags .tag");if(clickedTag){event.stopPropagation();const tagName=clickedTag.textContent.trim(),normalizedTagName=normalizeString(tagName);let filterCheckbox=tagFiltersContainer.querySelector(`input[value="${normalizedTagName}"]`);if(!filterCheckbox){const controlDiv=document.createElement("div");controlDiv.className="control",controlDiv.innerHTML=`\n                    <label class="checkbox">\n                        <input type="checkbox" value="${normalizedTagName}">\n                        <span>${tagName}</span>\n                    </label>\n                `;const firstNarratorFilter=tagFiltersContainer.querySelector(".narrator-only");tagFiltersContainer.insertBefore(controlDiv,firstNarratorFilter),filterCheckbox=controlDiv.querySelector("input")}filterCheckbox&&(filterCheckbox.checked=!filterCheckbox.checked,filterCheckbox.dispatchEvent(new Event("change",{bubbles:!0})))}else;})),fabBulkEdit&&fabBulkEdit.addEventListener("click",bulkEdit.enterBulkEditMode),fabHelp&&fabHelp.addEventListener("click",(()=>openModal(helpModal))),document.addEventListener("keydown",(event=>{if("Escape"===event.key){if(bulkEdit.isBulkEditingActive())return void bulkEdit.exitBulkEditMode();const activeModal=document.querySelector(".modal.is-active");if(activeModal)return void closeModal(activeModal);const editingContainer=document.querySelector(".is-editing-item");if(editingContainer){const editingCard=editingContainer.querySelector(".card.editing"),cancelButton=editingCard?.querySelector(".cancel-btn");return void(cancelButton&&cancelButton.click())}const detailsVisibleCard=document.querySelector(".card.is-details-visible");if(detailsVisibleCard)return void detailsVisibleCard.classList.remove("is-details-visible")}})),document.body.addEventListener("change",(event=>{const target=event.target;if(target.classList.contains("hp-current-input")){const hpComponent=target.closest(".shortcode-hp");if(!hpComponent)return;const{itemId:itemId,shortcode:shortcode,maxHp:maxHp}=hpComponent.dataset,newHpValue=parseInt(target.value,10);if(!itemId||!shortcode||isNaN(newHpValue))return;const clampedValue=Math.max(0,Math.min(newHpValue,parseInt(maxHp,10)));clampedValue!==newHpValue&&(target.value=clampedValue),handleShortcodeValueChange(itemId,shortcode,clampedValue,target)}})),document.body.addEventListener("focusout",(event=>{if(event.target.classList.contains("money-value-input")){!async function(inputElement){const moneyComponent=inputElement.closest(".shortcode-money");if(!moneyComponent||!moneyComponent.dataset.itemId)return;const{itemId:itemId,shortcode:encodedShortcode}=moneyComponent.dataset,item=allItems.find((i=>i.id===itemId));if(!item)return;const decodedShortcode=decodeURIComponent(encodedShortcode),originalArgs=shortcodeParser._parseArguments(decodedShortcode.slice(1,-1)).slice(1),originalParams=shortcodeParser._parseKeyValueArgs(originalArgs),originalValue=parseFloat(originalParams.current)||0,cleanedInput=inputElement.value.trim().replace(/\./g,"");let newValue=originalValue;const fullExpressionMatch=cleanedInput.match(/^(\d+\.?\d*)\s*([+\-*\/])\s*(\d+\.?\d*)$/);if(fullExpressionMatch){const operand1=parseFloat(fullExpressionMatch[1]),operator=fullExpressionMatch[2],operand2=parseFloat(fullExpressionMatch[3]);isNaN(operand1)||isNaN(operand2)||("+"===operator?newValue=operand1+operand2:"-"===operator?newValue=operand1-operand2:"*"===operator?newValue=operand1*operand2:"/"===operator&&0!==operand2&&(newValue=operand1/operand2))}else{const relativeOperationMatch=cleanedInput.match(/^([+\-*\/])\s*(\d+\.?\d*)$/);if(relativeOperationMatch){const operator=relativeOperationMatch[1],operand=parseFloat(relativeOperationMatch[2]);isNaN(operand)||("+"===operator?newValue=originalValue+operand:"-"===operator?newValue=originalValue-operand:"*"===operator?newValue=originalValue*operand:"/"===operator&&0!==operand&&(newValue=originalValue/operand))}else isNaN(parseFloat(cleanedInput))||(newValue=parseFloat(cleanedInput))}newValue=Math.round(100*newValue)/100;const newShortcode=decodedShortcode.replace(/current=([\d\."]+)/,`current="${newValue}"`),newContent=item.conteudo.replace(decodedShortcode,newShortcode);newContent!==item.conteudo&&await firebaseService.updateItem(item,{conteudo:newContent})}(event.target);const display=event.target.closest(".shortcode-money").querySelector(".money-value-display");event.target.classList.add("is-hidden"),display.classList.remove("is-hidden")}})),document.body.addEventListener("keydown",(event=>{if(event.target.classList.contains("money-value-input"))if("Enter"===event.key){event.preventDefault();const display=event.target.closest(".shortcode-money").querySelector(".money-value-display");event.target.classList.add("is-hidden"),display.classList.remove("is-hidden"),event.target.blur()}else if("Escape"===event.key){event.preventDefault();const moneyComponent=event.target.closest(".shortcode-money"),display=moneyComponent.querySelector(".money-value-display"),{shortcode:encodedShortcode}=moneyComponent.dataset,decodedShortcode=decodeURIComponent(encodedShortcode),originalArgs=shortcodeParser._parseArguments(decodedShortcode.slice(1,-1)).slice(1),originalParams=shortcodeParser._parseKeyValueArgs(originalArgs),originalValue=parseFloat(originalParams.current)||0;event.target.classList.add("is-hidden"),display.classList.remove("is-hidden"),event.target.value=originalValue}})),firebaseService.listenToItems((async snapshot=>{try{if(!isInitialGridLoaded){let items=snapshot.docs.map((doc=>({id:doc.id,...doc.data()})));return auth.isNarrator()||(items=items.filter((item=>!1!==item.isVisibleToPlayers))),allItems=items,allItems.sort(((a,b)=>(a.order||0)-(b.order||0))),await cardManager.loadItems(allItems),isInitialGridLoaded=!0,void applyFilters()}}catch(error){console.error("Erro ao processar os dados do Firebase:",error);const loadingIndicator=document.querySelector(".loading-indicator");loadingIndicator&&(loadingIndicator.innerHTML='\n                    <div class="notification is-danger">\n                        Erro ao carregar os cards. <a href="javascript:location.reload()">Tente novamente</a>.\n                    </div>\n                ')}snapshot.docChanges().forEach((change=>{const itemData={id:change.doc.id,...change.doc.data()},indexInCache=allItems.findIndex((i=>i.id===itemData.id)),isNarrator=auth.isNarrator();switch(change.type){case"added":(isNarrator||!1!==itemData.isVisibleToPlayers)&&-1===indexInCache&&allItems.push(itemData);break;case"modified":const shouldBeVisible=isNarrator||!1!==itemData.isVisibleToPlayers;indexInCache>-1?shouldBeVisible?allItems[indexInCache]=itemData:allItems.splice(indexInCache,1):shouldBeVisible&&allItems.push(itemData);break;case"removed":if(indexInCache>-1&&allItems.splice(indexInCache,1),detailModal.classList.contains("is-active")){const modalBox=detailModal.querySelector(".box");modalBox&&modalBox.dataset.itemId===itemData.id&&closeModal(detailModal)}}})),allItems.sort(((a,b)=>(a.order||0)-(b.order||0))),applyFilters()})),searchInput.addEventListener("input",(()=>{applyFilters(),updateClearButtonVisibility()})),tagFiltersContainer.addEventListener("change",(event=>{if("checkbox"===event.target.type){const clickedCheckbox=event.target,clickedValue=clickedCheckbox.value;if(auth.isNarrator()&&(clickedValue===VISIBILITY_FILTERS.VISIBLE||clickedValue===VISIBILITY_FILTERS.HIDDEN)&&clickedCheckbox.checked){const otherValue=clickedValue===VISIBILITY_FILTERS.VISIBLE?VISIBILITY_FILTERS.HIDDEN:VISIBILITY_FILTERS.VISIBLE,otherCheckbox=tagFiltersContainer.querySelector(`input[value="${otherValue}"]`);otherCheckbox&&otherCheckbox.checked&&(otherCheckbox.checked=!1,otherCheckbox.closest("label").classList.remove("is-active"))}clickedCheckbox.closest("label").classList.toggle("is-active",clickedCheckbox.checked),applyFilters(),updateActiveFiltersDisplay(),updateClearButtonVisibility()}})),activeFiltersContainer.addEventListener("click",(event=>{if(event.target.classList.contains("is-delete")){const valueToRemove=event.target.dataset.value,checkbox=tagFiltersContainer.querySelector(`input[value="${valueToRemove}"]`);checkbox&&(checkbox.checked=!1,checkbox.dispatchEvent(new Event("change",{bubbles:!0})))}})),clearFiltersBtn&&clearFiltersBtn.addEventListener("click",(()=>{searchInput.value="";tagFiltersContainer.querySelectorAll('input[type="checkbox"]').forEach((checkbox=>{checkbox.checked=!1,checkbox.closest("label").classList.remove("is-active")})),applyFilters(),updateActiveFiltersDisplay(),updateClearButtonVisibility()})),addCardButton.addEventListener("click",(()=>{formAddCard.reset(),grid.updateFileName(cardFileInput);const visibilityInput=document.getElementById("card-visibility");auth.isNarrator()&&visibilityInput&&(visibilityInput.checked=!1),openModal(addCardModal)})),formAddCard.addEventListener("submit",(async e=>{e.preventDefault();const submitButton=formAddCard.closest(".modal-card").querySelector('button[type="submit"]');submitButton.classList.add("is-loading");const file=cardFileInput.files.length>0?cardFileInput.files[0]:null,visibilityInput=document.getElementById("card-visibility"),itemData={titulo:document.getElementById("card-titulo").value,conteudo:document.getElementById("card-conteudo").value,descricao:document.getElementById("card-descricao").value,tags:cardTagsInput.value.split(",").map((t=>t.trim())).filter(Boolean),isVisibleToPlayers:!auth.isNarrator()||!visibilityInput||visibilityInput.checked};try{if(file){const dimensions=await cardRenderer.getImageDimensions(file);itemData.width=dimensions.width,itemData.height=dimensions.height}const newCardId=await firebaseService.addItem(itemData,file);formAddCard.reset(),grid.updateFileName(cardFileInput),closeModal(addCardModal);try{const userName=localStorage.getItem("rpgboard_user_name")||"Visitante";chat.logSystemMessage(`${userName} criou o card "${itemData.titulo}"`)}catch(e){}const unsubscribe=firebaseService.listenToItems((snapshot=>{snapshot.docs.find((doc=>doc.id===newCardId))&&setTimeout((()=>{grid.scrollToCard(newCardId),unsubscribe()}),100)}))}catch(error){console.error("Erro ao adicionar novo card:",error),alert("Falha ao adicionar o novo card.")}finally{submitButton.classList.remove("is-loading")}})),cardFileInput.addEventListener("change",(()=>grid.updateFileName(cardFileInput))),viewWrapper.classList.remove("view-board"),viewWrapper.classList.add("view-grid"),grid.show(),initializeTagInput(cardTagsInput,{suggestions:appSettings.recommendedTags||[]}),initializeTagInput(searchInput,{isMultiTag:!1,showRecsOnFocus:!1}),document.body.addEventListener("click",(async event=>{if(event.target.closest(".modal-card-body")){const codeBlock=event.target.closest("pre > code");codeBlock&&(await navigator.clipboard.writeText(codeBlock.textContent),function(event,text="Copiado!"){const feedbackEl=document.createElement("div");feedbackEl.textContent=text,feedbackEl.className="click-feedback",document.body.appendChild(feedbackEl),feedbackEl.style.left=`${event.pageX+15}px`,feedbackEl.style.top=`${event.pageY}px`,setTimeout((()=>{feedbackEl.style.opacity="0",setTimeout((()=>{feedbackEl.remove()}),500)}),700)}(event))}})),window.firebaseInstances&&window.firebaseInstances.db&&window.firebaseInstances.storage||console.error("As instâncias do Firebase não estão configuradas corretamente. Verifique a configuração do Firebase.")}));