import{initializeModals,openModal,closeModal}from"./modules/modal.js";import*as auth from"./modules/auth.js";import*as firebaseService from"./modules/firebaseService.js";import*as narrator from"./modules/narrator.js";import*as bulkEdit from"./modules/bulkEdit.js";import*as settings from"./modules/settings.js";import*as grid from"./modules/grid.js";import*as cardRenderer from"./modules/cardRenderer.js";import*as shortcodeParser from"./modules/shortcodeParser.js";import{visualizeDiceRoll}from"./modules/dice3d.js";import*as chat from"./modules/chat.js";import*as cardManager from"./modules/cardManager.js";import{processRoll}from"./modules/diceLogic.js";import{initializeLayout}from"./modules/layout.js";let allItems=[],isInitialGridLoaded=!1,appSettings={},tagSuggestionsContainer=null;const VISIBILITY_FILTERS={VISIBLE:"visible",HIDDEN:"hidden"};async function fetchRandomFantasyName(){try{const response=await fetch("https://gist.githubusercontent.com/tkfu/9819e4ac6d529e225e9fc58b358c3479/raw/srd_5e_monsters.json");if(!response.ok)throw new Error("Falha");const data=await response.json();return data[Math.floor(Math.random()*data.length)].name}catch(e){return"Viajante Desconhecido"}}function normalizeString(str){return str?str.toString().toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,""):""}function generateTagFilters(filters,container){if(!container||!Array.isArray(filters))return;const firstNarratorFilter=container.querySelector(".narrator-only");filters.forEach((filter=>{const controlDiv=document.createElement("div");controlDiv.className="control",controlDiv.innerHTML=`\n            <label class="checkbox">\n                <input type="checkbox" value="${filter.value}">\n                <span>${filter.label}</span>\n            </label>\n        `,container.insertBefore(controlDiv,firstNarratorFilter)}))}function injectDragDropStyles(){const style=document.createElement("style");style.textContent="\n        .card.muuri-item-draggable { cursor: grab; }\n        .card.muuri-item-dragging { cursor: grabbing; }\n        .card.muuri-item-draggable .card-content,\n        .card.muuri-item-draggable .card-image,\n        .card.muuri-item-draggable .card-actions-top,\n        .card.muuri-item-draggable .card-info-layer { cursor: auto; }\n    ",document.head.appendChild(style)}async function updateUserState(userName){const loginBtn=document.getElementById("user-login-btn"),userNameSpan=document.getElementById("user-name"),userNameInput=document.getElementById("user-name-input");if(userName){localStorage.setItem("rpgboard_user_name",userName),loginBtn&&(loginBtn.style.display="none"),userNameSpan&&(userNameSpan.textContent=userName,userNameSpan.style.display="inline-block"),userNameInput&&(userNameInput.value=userName);try{await firebaseService.saveUser(userName)}catch(error){console.error("Erro ao salvar usuário:",error)}}else localStorage.removeItem("rpgboard_user_name"),loginBtn&&(loginBtn.style.display="inline-flex"),userNameSpan&&(userNameSpan.style.display="none")}function handleDeleteItem(item){firebaseService.deleteItem(item).then((()=>{try{const u=localStorage.getItem("rpgboard_user_name")||"Visitante";chat.logSystemMessage(`${u} deletou o card "${item.titulo||item.id}"`)}catch(e){}})).catch((err=>{console.error(err),alert("Erro ao deletar.")}))}async function handlePositionChange(itemId,position){await firebaseService.updateItem({id:itemId},{boardPosition:position})}async function handleReorder(orderedIds){try{await firebaseService.updateItemsOrder(orderedIds)}catch(error){console.error("Failed to update card order:",error)}}document.addEventListener("DOMContentLoaded",(async()=>{await initializeLayout({fabActions:["settings","bulk-edit","converter","help","chat","dice","add-card"]}),chat.initializeChat();const addCardButton=document.getElementById("fab-add-card"),searchInput=(document.getElementById("fab-help"),document.getElementById("fab-bulk-edit"),document.getElementById("search-input")),activeFiltersContainer=document.getElementById("active-filters-container"),clearFiltersBtn=document.getElementById("clear-filters-btn"),tagFiltersContainer=document.getElementById("tag-filters"),viewWrapper=document.getElementById("view-wrapper"),detailModal=(document.querySelector(".top-bar-title"),document.getElementById("detail-modal")),addCardModal=document.getElementById("add-card-modal"),formAddCard=(document.getElementById("help-modal"),document.getElementById("form-add-card")),cardFileInput=document.getElementById("card-arquivo"),cardTagsInput=document.getElementById("card-tags"),userLoginBtn=(document.getElementById("grid-view-container"),document.getElementById("user-login-btn")),userLoginModal=document.getElementById("user-login-modal"),formUserLogin=document.getElementById("form-user-login"),userNameInput=document.getElementById("user-name-input"),diceFabWrapper=document.getElementById("dice-fab-wrapper"),diceMainBtn=document.getElementById("dice-main-btn"),diceQuickBtns=document.querySelectorAll(".dice-quick-btn"),toggleChatBtn=document.getElementById("toggle-chat-btn");await auth.initializeAuth(),bulkEdit.initializeBulkEdit(),settings.initializeSettings(),initializeModals();let savedUserName=localStorage.getItem("rpgboard_user_name");savedUserName||(savedUserName=await fetchRandomFantasyName(),localStorage.setItem("rpgboard_user_name",savedUserName)),updateUserState(savedUserName),userLoginBtn&&userLoginBtn.addEventListener("click",(()=>openModal(userLoginModal))),formUserLogin&&formUserLogin.addEventListener("submit",(e=>{e.preventDefault();const userName=userNameInput.value.trim();userName&&(updateUserState(userName),closeModal(userLoginModal),userNameInput.value="")})),diceQuickBtns&&diceQuickBtns.forEach((btn=>{btn.addEventListener("click",(()=>{const diceType=btn.dataset.dice;if(!diceType)return;const userName=localStorage.getItem("rpgboard_user_name")||"Visitante",command=`/r 1${diceType}`;firebaseService.addChatMessage(command,"user",userName),processRoll(command,null,userName,null),diceFabWrapper&&diceFabWrapper.classList.remove("is-active")}))})),diceMainBtn&&diceFabWrapper&&diceMainBtn.addEventListener("click",(()=>diceFabWrapper.classList.toggle("is-active"))),toggleChatBtn&&toggleChatBtn.addEventListener("click",(e=>{e.stopPropagation(),chat.toggleChat()})),injectDragDropStyles();try{appSettings=await firebaseService.getSettings(),window.appSettings=appSettings,appSettings.siteTitle&&(document.title=`${appSettings.siteTitle} - GameBoard`),"function"==typeof import("./modules/components/header.js").then&&import("./modules/components/header.js").then((mod=>mod.renderHeader&&mod.renderHeader())),cardRenderer.initializeCardRenderer(appSettings),generateTagFilters(appSettings.filters,tagFiltersContainer)}catch(error){console.error("Falha ao carregar as configurações do site:",error)}const cardActionHandlers={onDelete:handleDeleteItem,onEdit:function(card,item,container){container.classList.add("is-editing-item"),cardRenderer.renderCardEditMode(card,item,cardActionHandlers);const imageInput=card.querySelector(".edit-image-input");imageInput&&imageInput.addEventListener("change",(()=>{if(imageInput.files&&imageInput.files[0]){const file=imageInput.files[0],reader=new FileReader,figure=card.querySelector(".card-image .image"),img=figure.querySelector("img");card.querySelector(".card-image").classList.remove("is-placeholder"),reader.onload=e=>{img.src=e.target.result},reader.readAsDataURL(file),cardRenderer.getImageDimensions(file).then((dimensions=>{const newAspectRatio=dimensions.height/dimensions.width*100;figure.style.paddingBottom=`${newAspectRatio}%`,grid.refreshLayout()})),card._newImageFile=file}}))},onSave:async function(cardElement,item){const updatedData=cardRenderer.getCardFormData(cardElement),newImageFile=cardElement._newImageFile||null;try{if(newImageFile){const dimensions=await cardRenderer.getImageDimensions(newImageFile);updatedData.width=dimensions.width,updatedData.height=dimensions.height}await firebaseService.updateItem(item,updatedData,newImageFile),cardElement._newImageFile&&delete cardElement._newImageFile;try{const userName=localStorage.getItem("rpgboard_user_name")||"Visitante";chat.logSystemMessage(`${userName} atualizou o card "${updatedData.titulo||item.titulo}"`)}catch(e){}return{...item,...updatedData}}catch(error){throw console.error(error),alert("Falha ao salvar."),error}},onView:showDetailModal,onTagInputInit:inputElement=>initializeTagInput(inputElement,{suggestions:appSettings.recommendedTags||[]}),onPositionChange:handlePositionChange,onReorder:handleReorder};function updateMasterView(isNarrator){narrator.updateNarratorUI(isNarrator),document.body.classList.toggle("master-view",isNarrator)}function applyFilters(){const searchTerm=searchInput.value.trim(),selectedTags=Array.from(tagFiltersContainer.querySelectorAll('input:not([value="visible"]):not([value="hidden"]):checked')).map((checkbox=>checkbox.value)),normalizedSearchTerm=normalizeString(searchTerm),visibilityFilters_visible=tagFiltersContainer.querySelector(`input[value="${VISIBILITY_FILTERS.VISIBLE}"]`)?.checked,visibilityFilters_hidden=tagFiltersContainer.querySelector(`input[value="${VISIBILITY_FILTERS.HIDDEN}"]`)?.checked,loadingIndicator=document.getElementById("loading-indicator");loadingIndicator&&(loadingIndicator.style.display="none");const filteredItems=allItems.filter((dataItem=>{const textMatch=!normalizedSearchTerm||[dataItem.titulo,dataItem.conteudo,dataItem.descricao].some((t=>normalizeString(t||"").includes(normalizedSearchTerm)))||dataItem.tags.some((tag=>normalizeString(tag).includes(normalizedSearchTerm))),tagMatch=0===selectedTags.length||selectedTags.every((selectedTag=>dataItem.tags.some((itemTag=>normalizeString(itemTag)===selectedTag))));let visibilityMatch=!0;return auth.isNarrator()&&(visibilityFilters_visible||visibilityFilters_hidden)&&(visibilityFilters_visible&&!visibilityFilters_hidden?visibilityMatch=!1!==dataItem.isVisibleToPlayers:!visibilityFilters_visible&&visibilityFilters_hidden&&(visibilityMatch=!1===dataItem.isVisibleToPlayers)),textMatch&&tagMatch&&visibilityMatch}));viewWrapper.classList.contains("view-grid")&&grid.setItems(filteredItems,selectedTags),function(){const isSearchActive=""!==searchInput.value.trim(),areFiltersActive=null!==tagFiltersContainer.querySelector("input:checked");clearFiltersBtn&&clearFiltersBtn.classList.toggle("is-hidden",!isSearchActive&&!areFiltersActive)}(),function(){activeFiltersContainer.innerHTML="";tagFiltersContainer.querySelectorAll("input:checked").forEach((checkbox=>{const tagPill=document.createElement("div");tagPill.className="tags has-addons",tagPill.innerHTML=`<span class="tag is-link">${checkbox.nextElementSibling.textContent}</span><a class="tag is-delete" data-value="${checkbox.value}"></a>`,tagPill.querySelector(".is-delete").onclick=()=>{checkbox.checked=!1,applyFilters()},activeFiltersContainer.appendChild(tagPill)}))}()}function initializeTagInput(inputElement,options={}){const{isMultiTag:isMultiTag=!0,suggestions:suggestions=[],showRecsOnFocus:showRecsOnFocus=!0}=options;tagSuggestionsContainer||(tagSuggestionsContainer=document.createElement("div"),tagSuggestionsContainer.className="tag-suggestions",document.body.appendChild(tagSuggestionsContainer));const showSuggestions=list=>{if(tagSuggestionsContainer.innerHTML="",0===list.length)return void(tagSuggestionsContainer.style.display="none");list.forEach((tag=>{const item=document.createElement("div");item.className="tag-suggestion-item",item.textContent=tag,item.onmousedown=e=>{if(e.preventDefault(),isMultiTag){const parts=inputElement.value.split(",").map((p=>p.trim()));parts[parts.length-1]=tag,inputElement.value=parts.join(", ")+", "}else inputElement.value=tag;tagSuggestionsContainer.style.display="none",inputElement.focus()},tagSuggestionsContainer.appendChild(item)}));const rect=inputElement.getBoundingClientRect();tagSuggestionsContainer.style.cssText=`display:block; left:${rect.left+window.scrollX}px; top:${rect.bottom+window.scrollY}px; width:${rect.width}px;`};inputElement.onfocus=()=>{showRecsOnFocus&&""===inputElement.value&&showSuggestions(suggestions)},inputElement.oninput=()=>{const parts=inputElement.value.split(","),curr=normalizeString(parts[parts.length-1].trim());if(!curr)return showSuggestions(suggestions);const allTags=[...new Set(allItems.flatMap((i=>i.tags||[])))];showSuggestions(allTags.filter((t=>normalizeString(t).includes(curr))))},inputElement.onblur=()=>setTimeout((()=>{tagSuggestionsContainer.style.display="none"}),200)}function showDetailModal(item){if(!item||!detailModal)return;const content=detailModal.querySelector(".modal-content");content.innerHTML="";const box=document.createElement("div");box.className="box";const parsed=shortcodeParser.parseAllShortcodes(item),allShortcodes=(parsed.left||"")+(parsed.right||"")+(parsed.bottom||"")+(parsed.details||"");box.innerHTML=`\n            ${item.url?`<div class="modal-image-container"><img src="${item.url}"></div>`:""}\n            <div class="modal-text-container">\n                <h2 class="title is-3">${item.titulo}</h2>\n                <div class="content modal-shortcodes">${allShortcodes}</div>\n                ${item.descricao?`<hr><div class="content is-small"><strong>Descrição:</strong><br>${item.descricao.replace(/\n/g,"<br>")}</div>`:""}\n            </div>\n        `,content.appendChild(box),openModal(detailModal)}await cardManager.initialize(cardActionHandlers),grid.initializeGrid(cardActionHandlers),viewWrapper.classList.add("view-grid"),grid.show(),updateMasterView(auth.isNarrator()),window.addEventListener("narratorStatusChange",(()=>{const isNarrator=auth.isNarrator();updateMasterView(isNarrator),isNarrator||bulkEdit.exitBulkEditMode(),applyFilters()})),firebaseService.listenToItems((async snapshot=>{try{if(!isInitialGridLoaded){let items=snapshot.docs.map((doc=>({id:doc.id,...doc.data()})));return auth.isNarrator()||(items=items.filter((item=>!1!==item.isVisibleToPlayers))),allItems=items,allItems.sort(((a,b)=>(a.order||0)-(b.order||0))),await cardManager.loadItems(allItems),isInitialGridLoaded=!0,void applyFilters()}}catch(error){console.error(error)}snapshot.docChanges().forEach((change=>{const itemData={id:change.doc.id,...change.doc.data()},indexInCache=allItems.findIndex((i=>i.id===itemData.id)),isNarrator=auth.isNarrator();if("added"===change.type)(isNarrator||!1!==itemData.isVisibleToPlayers)&&-1===indexInCache&&allItems.push(itemData);else if("modified"===change.type){const visible=isNarrator||!1!==itemData.isVisibleToPlayers;indexInCache>-1?visible?allItems[indexInCache]=itemData:allItems.splice(indexInCache,1):visible&&allItems.push(itemData)}else"removed"===change.type&&(indexInCache>-1&&allItems.splice(indexInCache,1),detailModal.classList.contains("is-active")&&detailModal.querySelector(".box")?.dataset.itemId===itemData.id&&closeModal(detailModal))})),allItems.sort(((a,b)=>(a.order||0)-(b.order||0))),applyFilters()})),firebaseService.listenToDiceRolls((change=>{const d=change.doc.data();if(d){let t=(d.diceType||"").toString().toLowerCase().trim().replace(/^\d+/,"");visualizeDiceRoll(t,d.result,d.userName,d.label)}})),searchInput.addEventListener("input",applyFilters),tagFiltersContainer.addEventListener("change",applyFilters),clearFiltersBtn&&clearFiltersBtn.addEventListener("click",(()=>{searchInput.value="",tagFiltersContainer.querySelectorAll('input[type="checkbox"]').forEach((c=>{c.checked=!1})),applyFilters()})),addCardButton&&addCardButton.addEventListener("click",(()=>{formAddCard.reset(),grid.updateFileName(cardFileInput),openModal(addCardModal)})),formAddCard.addEventListener("submit",(async e=>{e.preventDefault();const btn=formAddCard.querySelector('button[type="submit"]');btn.classList.add("is-loading");const data={titulo:document.getElementById("card-titulo").value,conteudo:document.getElementById("card-conteudo").value,descricao:document.getElementById("card-descricao").value,tags:cardTagsInput.value.split(",").map((t=>t.trim())).filter(Boolean),isVisibleToPlayers:!auth.isNarrator()||document.getElementById("card-visibility").checked};try{const id=await firebaseService.addItem(data,cardFileInput.files[0]);closeModal(addCardModal),grid.scrollToCard(id)}catch(error){console.error(error),alert("Falha ao adicionar.")}finally{btn.classList.remove("is-loading")}})),document.body.addEventListener("click",(event=>{const target=event.target,activeMoneyInput=document.querySelector(".money-value-input:not(.is-hidden)");!activeMoneyInput||activeMoneyInput.contains(target)||target.closest(".shortcode-money")||(activeMoneyInput.closest(".shortcode-money").querySelector(".money-value-display").classList.remove("is-hidden"),activeMoneyInput.classList.add("is-hidden"));const moneyComponent=target.closest(".shortcode-money");if(moneyComponent){const display=moneyComponent.querySelector(".money-value-display"),input=moneyComponent.querySelector(".money-value-input");display&&input&&(display.classList.add("is-hidden"),input.classList.remove("is-hidden"),input.focus(),input.select())}const cardLink=target.closest(".card-link");if(cardLink){event.stopPropagation();const foundCard=allItems.find((item=>normalizeString(item.titulo)===normalizeString(cardLink.dataset.cardName)));foundCard&&showDetailModal(foundCard)}const countTrigger=target.closest(".count-btn, .count-checkbox");if(countTrigger){event.stopPropagation();const countComponent=countTrigger.closest(".shortcode-count");if(!countComponent)return;const{itemId:itemId,shortcode:shortcode}=countComponent.dataset;if(itemId&&shortcode){const decoded=decodeURIComponent(shortcode),max=parseInt(decoded.match(/max=(?:["']?)(\d+)(?:["']?)/)?.[1]||0);let current=parseInt(decoded.match(/current=(?:["']?)(-?\d+)(?:["']?)/)?.[1]||0),next=current;if(countTrigger.classList.contains("count-btn"))next="increment"===countTrigger.dataset.action?Math.min(current+1,max):Math.max(current-1,0);else if(countTrigger.classList.contains("count-checkbox")){const val=parseInt(countTrigger.dataset.value,10);next=val===current?0:val}!async function(itemId,encodedShortcode,newCurrentValue,triggerElement=null){const item=allItems.find((i=>i.id===itemId));if(!item||!item.conteudo)return;if(triggerElement){const componentRoot=triggerElement.closest(".shortcode-hp, .shortcode-count");componentRoot&&(componentRoot.classList.add("is-updating"),setTimeout((()=>componentRoot.classList.remove("is-updating")),700))}const decodedShortcode=decodeURIComponent(encodedShortcode);let newShortcode;newShortcode=/current=/.test(decodedShortcode)?decodedShortcode.replace(/current=(?:["']?)-?\d+(?:\.\d+)?(?:["']?)/,`current="${newCurrentValue}"`):decodedShortcode.replace(/]$/,` current="${newCurrentValue}"]`);const newContent=item.conteudo.replace(decodedShortcode,newShortcode);try{await firebaseService.updateItem(item,{conteudo:newContent})}catch(error){console.error(error)}}(itemId,shortcode,next,countTrigger)}}})),document.body.addEventListener("focusout",(event=>{event.target.classList.contains("money-value-input")&&(!async function(inputElement){const moneyComponent=inputElement.closest(".shortcode-money");if(!moneyComponent||!moneyComponent.dataset.itemId)return;const{itemId:itemId,shortcode:encodedShortcode}=moneyComponent.dataset,item=allItems.find((i=>i.id===itemId));if(!item)return;const decodedShortcode=decodeURIComponent(encodedShortcode),originalArgs=shortcodeParser._parseArguments(decodedShortcode.slice(1,-1)).slice(1),originalParams=shortcodeParser._parseKeyValueArgs(originalArgs),originalValue=parseFloat(originalParams.current)||0;let cleanedInput=inputElement.value.trim().replace(/\u00A0/g," ").replace(/\s+/g,"");if(""===cleanedInput)return;cleanedInput.includes(".")&&cleanedInput.includes(",")?cleanedInput=cleanedInput.indexOf(".")<cleanedInput.indexOf(",")?cleanedInput.replace(/\./g,"").replace(/,/g,"."):cleanedInput.replace(/,/g,""):cleanedInput.includes(",")&&(cleanedInput=cleanedInput.replace(/,/g,"."));let newValue=originalValue;const fullExpr=cleanedInput.match(/^(-?\d+(?:\.\d+)?)\s*([+\-*\/])\s*(-?\d+(?:\.\d+)?)$/);if(fullExpr){const v1=parseFloat(fullExpr[1]),op=fullExpr[2],v2=parseFloat(fullExpr[3]);isNaN(v1)||isNaN(v2)||("+"===op?newValue=v1+v2:"-"===op?newValue=v1-v2:"*"===op?newValue=v1*v2:"/"===op&&0!==v2&&(newValue=v1/v2))}else{const relExpr=cleanedInput.match(/^([+\-*\/])\s*(-?\d+(?:\.\d+)?)$/);if(relExpr){const op=relExpr[1],v=parseFloat(relExpr[2]);isNaN(v)||("+"===op?newValue=originalValue+v:"-"===op?newValue=originalValue-v:"*"===op?newValue=originalValue*v:"/"===op&&0!==v&&(newValue=originalValue/v))}else isNaN(parseFloat(cleanedInput))||(newValue=parseFloat(cleanedInput))}if(newValue=Math.round(100*newValue)/100,isNaN(newValue))return;const newShortcode=decodedShortcode.replace(/current=(?:["']?)-?\d+(?:\.\d+)?(?:["']?)/,`current="${newValue}"`),newContent=item.conteudo.replace(decodedShortcode,newShortcode);newContent!==item.conteudo&&await firebaseService.updateItem(item,{conteudo:newContent})}(event.target),event.target.closest(".shortcode-money").querySelector(".money-value-display").classList.remove("is-hidden"),event.target.classList.add("is-hidden"))})),initializeTagInput(cardTagsInput,{suggestions:appSettings.recommendedTags||[]}),initializeTagInput(searchInput,{isMultiTag:!1,showRecsOnFocus:!1})}));